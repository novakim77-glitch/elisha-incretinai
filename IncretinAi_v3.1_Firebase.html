<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IncretinA i Pro v3.1 â€” Firebase Cloud Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK (Compat for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --bg: #f0f4f8; --surface: #ffffff; --surface-alt: #f7f9fc;
            --text: #0f172a; --text-sub: #64748b;
            --primary: #2563eb; --primary-glow: rgba(37,99,235,0.15);
            --success: #10b981; --success-glow: rgba(16,185,129,0.15);
            --danger: #ef4444; --danger-glow: rgba(239,68,68,0.1);
            --accent: #f59e0b; --accent-glow: rgba(245,158,11,0.15);
            --border: #e2e8f0;
            --shadow: 0 8px 32px rgba(15,23,42,0.06);
            --shadow-lg: 0 16px 48px rgba(15,23,42,0.1);
            --golden-gradient: linear-gradient(135deg, #f59e0b, #ef4444);
            --card-radius: 24px;
            --transition: 0.5s cubic-bezier(0.4,0,0.2,1);
        }
        [data-theme="night"] {
            --bg: #0c1222; --surface: #1a2236; --surface-alt: #151d30;
            --text: #e2e8f0; --text-sub: #94a3b8;
            --primary: #60a5fa; --primary-glow: rgba(96,165,250,0.12);
            --success: #34d399; --success-glow: rgba(52,211,153,0.12);
            --danger: #f87171; --danger-glow: rgba(248,113,113,0.1);
            --accent: #fbbf24; --accent-glow: rgba(251,191,36,0.12);
            --border: #2a3548;
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text);
            padding: 16px; display: flex; flex-direction: column; align-items: center;
            transition: background var(--transition), color var(--transition); min-height: 100vh;
        }
        .container { max-width: 820px; width: 100%; }

        /* ===== AUTH SCREEN ===== */
        .auth-screen {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 3000;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .auth-card {
            background: rgba(255,255,255,0.04); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 32px;
            padding: 48px 36px; width: 90%; max-width: 420px; text-align: center;
        }
        .auth-logo { font-size: 3rem; margin-bottom: 8px; }
        .auth-title { font-size: 1.5rem; font-weight: 900; color: #e2e8f0; margin-bottom: 4px; }
        .auth-subtitle { font-size: 0.8rem; color: #94a3b8; margin-bottom: 32px; font-weight: 500; }
        .auth-input {
            width: 100%; padding: 14px 18px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.06); color: #e2e8f0; font-family: 'Outfit', sans-serif;
            font-size: 0.9rem; font-weight: 500; margin-bottom: 12px; transition: border-color 0.2s;
        }
        .auth-input:focus { outline: none; border-color: #60a5fa; }
        .auth-input::placeholder { color: #64748b; }
        .auth-btn {
            width: 100%; padding: 15px; border-radius: 14px; border: none; font-family: 'Outfit', sans-serif;
            font-weight: 800; font-size: 0.9rem; cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .auth-btn:hover { transform: translateY(-2px); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .auth-btn-primary { background: #2563eb; color: white; }
        .auth-btn-secondary { background: rgba(255,255,255,0.06); color: #94a3b8; border: 1px solid rgba(255,255,255,0.1); }
        .auth-btn-google { background: #ffffff; color: #1f2937; }
        .auth-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; color: #475569; font-size: 0.75rem; font-weight: 600; }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.08); }
        .auth-toggle { color: #60a5fa; font-size: 0.8rem; font-weight: 600; cursor: pointer; margin-top: 16px; }
        .auth-toggle:hover { text-decoration: underline; }
        .auth-error { color: #f87171; font-size: 0.78rem; font-weight: 600; margin-bottom: 12px; min-height: 20px; }
        .auth-status-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 3px; z-index: 3001;
            background: transparent; transition: background 0.3s;
        }
        .auth-status-bar.loading { background: linear-gradient(90deg, #2563eb, #7c3aed, #2563eb); background-size: 200%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        /* ===== SYNC STATUS ===== */
        .sync-badge {
            display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px;
            border-radius: 20px; font-size: 0.65rem; font-weight: 700;
            background: var(--success-glow); color: var(--success);
        }
        .sync-badge.offline { background: var(--danger-glow); color: var(--danger); }
        .sync-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .user-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; width: 100%; padding: 0 4px;
        }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .user-avatar {
            width: 30px; height: 30px; border-radius: 10px; background: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; color: white; font-weight: 800;
        }
        .user-email { font-size: 0.72rem; color: var(--text-sub); font-weight: 600; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .logout-btn {
            padding: 5px 12px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--surface); font-family: 'Outfit', sans-serif; font-size: 0.68rem;
            font-weight: 700; color: var(--text-sub); cursor: pointer; transition: 0.2s;
        }
        .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

        /* ===== HEADER ===== */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon {
            width: 44px; height: 44px; border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.3rem; box-shadow: 0 4px 16px rgba(37,99,235,0.3);
        }
        .logo-text h1 { font-size: 1.25rem; font-weight: 900; color: var(--text); line-height: 1.2; }
        .logo-text span { font-size: 0.6rem; font-weight: 600; color: var(--text-sub); letter-spacing: 1px; }
        .header-actions { display: flex; gap: 8px; }
        .icon-btn {
            width: 42px; height: 42px; border-radius: 14px; border: 1px solid var(--border);
            background: var(--surface); cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: 0.2s; color: var(--text);
        }
        .icon-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        /* ===== BIO-SYNC TIMER ===== */
        .biosync-card {
            background: var(--surface); border-radius: var(--card-radius); padding: 28px;
            margin-bottom: 20px; border: 2px solid var(--border); box-shadow: var(--shadow);
            position: relative; overflow: hidden; width: 100%;
            transition: border-color var(--transition), background var(--transition);
        }
        .biosync-card::before { content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--golden-gradient); }
        [data-theme="night"] .biosync-card { border-color: #2a3548; }
        [data-theme="night"] .biosync-card::before { background: linear-gradient(135deg, #3b82f6, #6366f1); }
        .biosync-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .biosync-mode { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 0.72rem; font-weight: 800; letter-spacing: 0.5px; }
        .mode-day { background: #fef3c7; color: #92400e; }
        .mode-night { background: #1e1b4b; color: #a5b4fc; }
        .biosync-location { font-size: 0.7rem; color: var(--text-sub); font-weight: 600; }
        .golden-time-display { display: flex; align-items: center; gap: 24px; margin-bottom: 20px; }
        .countdown-ring { width: 110px; height: 110px; position: relative; flex-shrink: 0; }
        .countdown-ring svg { transform: rotate(-90deg); }
        .countdown-ring .ring-bg { fill: none; stroke: var(--border); stroke-width: 6; }
        .countdown-ring .ring-progress { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
        .countdown-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .countdown-time { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; color: var(--text); display: block; }
        .countdown-label { font-size: 0.55rem; font-weight: 700; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; }
        .golden-info { flex: 1; }
        .golden-info .gi-title { font-size: 0.95rem; font-weight: 800; color: var(--text); margin-bottom: 6px; }
        .golden-info .gi-sub { font-size: 0.78rem; color: var(--text-sub); line-height: 1.5; }
        .sun-times { display: flex; gap: 16px; margin-top: 10px; }
        .sun-time { display: flex; align-items: center; gap: 5px; font-size: 0.72rem; font-weight: 700; color: var(--text-sub); }
        .sun-time span { font-family: 'JetBrains Mono', monospace; color: var(--text); }
        .biosync-progress { background: var(--surface-alt); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
        .progress-bar-wrap { flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease, background 0.5s; }
        .progress-pct { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 700; min-width: 42px; text-align: right; }

        /* ===== STAT / IMEM / AI / CHARTS ===== */
        .stat-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 20px; width: 100%; }
        .stat-item { background: var(--surface); padding: 16px 12px; border-radius: 18px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); transition: background var(--transition), border-color var(--transition); }
        .stat-val { display: block; font-family: 'JetBrains Mono', monospace; font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .stat-lbl { font-size: 0.6rem; font-weight: 700; color: var(--text-sub); margin-bottom: 4px; display: block; letter-spacing: 0.5px; text-transform: uppercase; }
        .imem-card { background: var(--surface); border-radius: var(--card-radius); padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); width: 100%; transition: background var(--transition), border-color var(--transition); }
        .imem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .imem-title { font-size: 0.75rem; font-weight: 800; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; }
        .imem-coefficients { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 16px; }
        .coeff-item { background: var(--surface-alt); border-radius: 14px; padding: 14px; text-align: center; border: 1px solid var(--border); }
        .coeff-symbol { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; display: block; margin-bottom: 2px; }
        .coeff-value { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 700; display: block; }
        .coeff-label { font-size: 0.6rem; font-weight: 700; color: var(--text-sub); letter-spacing: 0.5px; }
        .ai-card { background: var(--surface); border-radius: var(--card-radius); padding: 24px; margin-bottom: 20px; border: 2px solid var(--primary); box-shadow: 0 8px 32px var(--primary-glow); width: 100%; transition: background var(--transition), border-color var(--transition); }
        .ai-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .ai-title { font-weight: 800; color: var(--primary); font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .ai-persona-select { border: 1px solid var(--border); border-radius: 10px; padding: 5px 10px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.72rem; background: var(--surface-alt); color: var(--text); cursor: pointer; }
        .ai-content { background: var(--surface-alt); padding: 16px; border-radius: 14px; font-size: 0.88rem; line-height: 1.7; border-left: 4px solid var(--primary); color: var(--text-sub); font-weight: 500; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; width: 100%; }
        .chart-card { background: var(--surface); border-radius: var(--card-radius); padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); transition: background var(--transition), border-color var(--transition); }
        .chart-title { font-size: 0.7rem; font-weight: 800; margin-bottom: 10px; display: block; color: var(--text-sub); letter-spacing: 0.5px; text-transform: uppercase; }

        /* ===== GLASS CARD / INPUTS / ROUTINE ===== */
        .glass-card { background: var(--surface); border-radius: var(--card-radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; width: 100%; border: 1px solid var(--border); transition: background var(--transition), border-color var(--transition); }
        .section-label { font-size: 0.7rem; font-weight: 800; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 14px; display: block; }
        .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px,1fr)); gap: 10px; margin-bottom: 18px; }
        .input-group label { font-size: 0.65rem; font-weight: 700; color: var(--text-sub); display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.85rem; background: var(--surface-alt); color: var(--text); transition: border-color 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }
        .routine-date-bar { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 16px; }
        .routine-date-bar > div { flex: 1; }
        .item { background: var(--surface); border-radius: 18px; padding: 16px 18px; margin-bottom: 10px; display: flex; gap: 14px; align-items: center; border-left: 5px solid var(--border); cursor: pointer; transition: all 0.25s ease; position: relative; }
        .item:hover { transform: translateX(4px); }
        .item.checked { background: var(--success-glow); border-left-color: var(--success); }
        .item.critical { border-left-color: var(--danger); }
        .item.critical.checked { border-left-color: var(--success); }
        .item-icon { width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; background: var(--surface-alt); flex-shrink: 0; }
        .item.checked .item-icon { background: var(--success); }
        .item-body { flex: 1; min-width: 0; }
        .item-time { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; color: var(--primary); }
        .item-title { font-size: 0.9rem; font-weight: 800; color: var(--text); margin: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-action { font-size: 0.72rem; color: var(--text-sub); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .score-badge { background: var(--surface-alt); padding: 4px 10px; border-radius: 10px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; color: var(--text-sub); flex-shrink: 0; }
        .item.checked .score-badge { background: var(--success); color: white; }
        .fasting-overlay { display: none; background: var(--surface-alt); border-radius: 18px; padding: 28px; text-align: center; margin-bottom: 20px; border: 1px dashed var(--border); }
        .fasting-overlay.active { display: block; }
        .fasting-overlay .fo-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .fasting-overlay .fo-title { font-size: 1rem; font-weight: 800; color: var(--text); margin-bottom: 6px; }
        .fasting-overlay .fo-sub { font-size: 0.8rem; color: var(--text-sub); line-height: 1.6; }
        .btn { padding: 14px 20px; border-radius: 14px; border: none; font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 0.85rem; cursor: pointer; color: white; text-align: center; transition: transform 0.2s, box-shadow 0.2s; display: block; width: 100%; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary); box-shadow: 0 4px 16px var(--primary-glow); }
        .btn-success { background: var(--success); box-shadow: 0 4px 16px var(--success-glow); }

        /* ===== MODAL ===== */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface); width: 95%; max-width: 680px; padding: 32px; border-radius: 28px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h2 { font-size: 1.2rem; font-weight: 900; color: var(--primary); }
        .modal-close { background: var(--surface-alt); border: none; width: 36px; height: 36px; border-radius: 10px; font-size: 1.2rem; cursor: pointer; color: var(--text); }
        .guide-step { margin-bottom: 22px; padding-bottom: 18px; border-bottom: 1px solid var(--border); }
        .guide-step:last-child { border-bottom: none; }
        .guide-time { font-family: 'JetBrains Mono', monospace; color: var(--primary); font-weight: 700; font-size: 0.85rem; }
        .guide-title { font-size: 1rem; font-weight: 800; color: var(--text); margin: 4px 0 10px; display: block; }
        .guide-box { background: var(--surface-alt); padding: 14px; border-radius: 14px; border-left: 4px solid var(--accent); }
        .guide-label { font-size: 0.65rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .guide-text { font-size: 0.82rem; line-height: 1.65; color: var(--text-sub); }
        .guide-text b { color: var(--text); }

        @media (max-width: 600px) {
            .stat-grid { grid-template-columns: repeat(2,1fr); }
            .dashboard-grid { grid-template-columns: 1fr; }
            .golden-time-display { flex-direction: column; align-items: flex-start; gap: 14px; }
            .countdown-ring { align-self: center; }
            .auth-card { padding: 32px 24px; }
        }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<!-- ===== AUTH STATUS BAR ===== -->
<div class="auth-status-bar" id="status-bar"></div>

<!-- ===== AUTH SCREEN ===== -->
<div class="auth-screen" id="auth-screen">
    <div class="auth-card">
        <div class="auth-logo">ğŸ§¬</div>
        <div class="auth-title">IncretinA i Pro</div>
        <div class="auth-subtitle">v3.1 Firebase Cloud Edition</div>
        <div class="auth-error" id="auth-error"></div>

        <!-- Login Form -->
        <div id="auth-login">
            <input class="auth-input" type="email" id="auth-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" autocomplete="email">
            <input class="auth-input" type="password" id="auth-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="current-password">
            <button class="auth-btn auth-btn-primary" onclick="emailLogin()">ğŸ” ë¡œê·¸ì¸</button>
            <div class="auth-divider">ë˜ëŠ”</div>
            <button class="auth-btn auth-btn-secondary" onclick="guestLogin()">ğŸ‘¤ ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°</button>
            <div class="auth-toggle" onclick="toggleAuthMode()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <b>íšŒì›ê°€ì…</b></div>
        </div>

        <!-- Register Form -->
        <div id="auth-register" style="display:none;">
            <input class="auth-input" type="email" id="reg-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" autocomplete="email">
            <input class="auth-input" type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="new-password">
            <input class="auth-input" type="password" id="reg-pw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">
            <button class="auth-btn auth-btn-primary" onclick="emailRegister()">âœ¨ íšŒì›ê°€ì…</button>
            <div class="auth-toggle" onclick="toggleAuthMode()">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <b>ë¡œê·¸ì¸</b></div>
        </div>
    </div>
</div>

<!-- ===== MAIN APP ===== -->
<div class="container" id="app-container" style="display:none;">

    <!-- User Bar -->
    <div class="user-bar no-print">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">?</div>
            <div>
                <div class="user-email" id="user-email">-</div>
                <div class="sync-badge" id="sync-badge"><span class="dot"></span> Cloud Sync</div>
            </div>
        </div>
        <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <header>
        <div class="logo">
            <div class="logo-icon">ğŸ§¬</div>
            <div class="logo-text"><h1>IncretinA i Pro</h1><span>v3.1 FIREBASE CLOUD EDITION</span></div>
        </div>
        <div class="header-actions no-print">
            <button class="icon-btn" onclick="toggleThemeManual()" id="theme-toggle">â˜€ï¸</button>
            <button class="icon-btn" onclick="toggleModal('help-modal')">ğŸ’¡</button>
        </div>
    </header>

    <!-- Bio-Sync Timer -->
    <div class="biosync-card" id="biosync-card">
        <div class="biosync-header">
            <div class="biosync-mode mode-day" id="mode-badge">â˜€ï¸ DAY MODE â€” GOLDEN TIME</div>
            <div class="biosync-location" id="location-label">ğŸ“ ì„œìš¸ (37.5Â°N)</div>
        </div>
        <div class="golden-time-display">
            <div class="countdown-ring">
                <svg width="110" height="110" viewBox="0 0 110 110">
                    <circle class="ring-bg" cx="55" cy="55" r="48"/>
                    <circle class="ring-progress" id="countdown-ring" cx="55" cy="55" r="48" stroke-dasharray="301.6" stroke-dashoffset="0" stroke="var(--accent)"/>
                </svg>
                <div class="countdown-center">
                    <span class="countdown-time" id="countdown-time">--:--</span>
                    <span class="countdown-label" id="countdown-label">ë‚¨ì€ ì‹œê°„</span>
                </div>
            </div>
            <div class="golden-info">
                <div class="gi-title" id="golden-title">ğŸŒ… ê³¨ë“ íƒ€ì„ ì§„í–‰ ì¤‘</div>
                <div class="gi-sub" id="golden-sub">ì¸í¬ë ˆí‹´ í˜¸ë¥´ëª¬ ë¶„ë¹„ê°€ í™œë°œí•œ ì‹œê°„ì…ë‹ˆë‹¤.</div>
                <div class="sun-times">
                    <div class="sun-time">ğŸŒ… ì¼ì¶œ <span id="sunrise-time">--:--</span></div>
                    <div class="sun-time">ğŸŒ‡ ì¼ëª° <span id="sunset-time">--:--</span></div>
                </div>
            </div>
        </div>
        <div class="biosync-progress">
            <span style="font-size:0.7rem; font-weight:700; color:var(--text-sub);">ê³¨ë“ íƒ€ì„</span>
            <div class="progress-bar-wrap"><div class="progress-bar-fill" id="golden-progress" style="width:0%; background:var(--golden-gradient);"></div></div>
            <span class="progress-pct" id="golden-pct">0%</span>
        </div>
    </div>

    <div class="stat-grid no-print">
        <div class="stat-item"><span class="stat-lbl">í˜„ì¬ BMI</span><span class="stat-val" id="bmi-v">0.0</span></div>
        <div class="stat-item"><span class="stat-lbl">ëª©í‘œ ë‹¬ì„±ë¥ </span><span class="stat-val" id="ach-v" style="color:var(--danger);">0%</span></div>
        <div class="stat-item"><span class="stat-lbl">ì˜¤ëŠ˜ ì ìˆ˜</span><span class="stat-val" id="today-score">0</span></div>
        <div class="stat-item"><span class="stat-lbl">ì§€ë°©ì—°ì†Œ ê°€ì†</span><span class="stat-val" id="burn-rate" style="color:var(--success);">0%</span></div>
    </div>

    <div class="imem-card">
        <div class="imem-header"><span class="imem-title">ğŸ“ IMEM ì‹¤ì‹œê°„ ê³„ìˆ˜</span></div>
        <div class="imem-coefficients">
            <div class="coeff-item"><span class="coeff-symbol" style="color:var(--accent);">Î±</span><span class="coeff-value" id="alpha-val" style="color:var(--accent);">1.00</span><span class="coeff-label">Timing</span></div>
            <div class="coeff-item"><span class="coeff-symbol" style="color:var(--primary);">Î²</span><span class="coeff-value" id="beta-val" style="color:var(--primary);">1.00</span><span class="coeff-label">Sequence</span></div>
            <div class="coeff-item"><span class="coeff-symbol" style="color:var(--success);">Î³</span><span class="coeff-value" id="gamma-val" style="color:var(--success);">1.00</span><span class="coeff-label">Sensitivity</span></div>
        </div>
        <div style="background:var(--surface-alt); border-radius:12px; padding:12px 16px; font-size:0.75rem; color:var(--text-sub); font-family:'JetBrains Mono',monospace; text-align:center;">
            Î”Weight = f(BMR) Ã— [<span style="color:var(--accent); font-weight:700;">Î±</span> Ã— <span style="color:var(--primary); font-weight:700;">Î²</span> Ã— <span style="color:var(--success); font-weight:700;">Î³</span>] Ã— Compliance
        </div>
    </div>

    <div class="ai-card">
        <div class="ai-top">
            <div class="ai-title">ğŸ§  AI ë„›ì§€</div>
            <select class="ai-persona-select" id="ai-persona" onchange="updateAIStatus()"><option value="clinical">ğŸ”¬ ì„ìƒ ì „ë¬¸ê°€</option><option value="driver">ğŸ”¥ ê²°ê³¼ ì§€í–¥</option><option value="empathetic">ğŸ¤ ê³µê° íŒŒíŠ¸ë„ˆ</option></select>
        </div>
        <div id="ai-nudge" class="ai-content">ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ ë£¨í‹´ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.</div>
    </div>

    <div class="dashboard-grid no-print">
        <div class="chart-card" id="sim-view" style="display:none;"><span class="chart-title">ğŸ“‰ IMEM 4ì£¼ ì˜ˆì¸¡</span><canvas id="simChart" height="200"></canvas></div>
        <div class="chart-card" id="trend-view" style="display:none;"><span class="chart-title">ğŸ“ˆ ì‹¤ì œ ì²´ì¤‘ ì¶”ì´</span><canvas id="trendChart" height="200"></canvas></div>
    </div>

    <div class="glass-card">
        <span class="section-label">ğŸ‘¤ í”„ë¡œí•„ ë° ë¶„ì„ ì„¤ì •</span>
        <div class="profile-grid no-print">
            <div class="input-group"><label>ì±Œë¦°ì§€ ì‹œì‘ì¼</label><input type="date" id="p-start"></div>
            <div class="input-group"><label>ë‹¹ë‡¨ ìœ ë¬´</label><select id="p-diabetic"><option value="no">ë¹„ë‹¹ë‡¨ì¸</option><option value="pre">ì „ë‹¹ë‡¨</option><option value="yes">ë‹¹ë‡¨(ì œ2í˜•)</option></select></div>
            <div class="input-group"><label>í‚¤ (cm)</label><input type="number" id="p-h" value="175"></div>
            <div class="input-group"><label>ì‹œì‘ ì²´ì¤‘(kg)</label><input type="number" id="p-sw" step="0.1" value="80"></div>
            <div class="input-group"><label>í˜„ì¬ ì²´ì¤‘(kg)</label><input type="number" id="p-cw" step="0.1" value="78.5"></div>
            <div class="input-group"><label>ëª©í‘œ ì²´ì¤‘(kg)</label><input type="number" id="p-gw" step="0.1" value="70"></div>
            <div class="input-group"><label>ì£¼ê°„ ê·¼ë ¥ìš´ë™(íšŒ)</label><input type="number" id="p-exercise" value="3" min="0" max="7"></div>
            <div class="input-group"><label>ìœ„ë„ (ìë™)</label><input type="number" id="p-lat" step="0.1" value="37.5"></div>
        </div>
        <button class="btn btn-primary no-print" onclick="runComprehensiveAnalysis()">ğŸ”¬ ë¶„ì„ ì‹¤í–‰ ë° ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div class="fasting-overlay" id="fasting-overlay">
        <div class="fo-icon">ğŸŒ™</div>
        <div class="fo-title">ëŒ€ì‚¬ íœ´ì‹ ëª¨ë“œ (Metabolic Rest)</div>
        <div class="fo-sub">ê³¨ë“ íƒ€ì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•¼ê°„ ê³µë³µì„ ìœ ì§€í•˜ë©´ ë‚´ì¼ ì•„ì¹¨ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±ì´ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤. ğŸ”¥</div>
    </div>

    <div class="glass-card no-print" id="routine-section">
        <span class="section-label">ğŸ“‹ ì˜¤ëŠ˜ì˜ ì¸í¬ë ˆí‹´ ë£¨í‹´</span>
        <div class="routine-date-bar">
            <div><label style="font-size:0.65rem; font-weight:700; color:var(--text-sub);">ê¸°ë¡ ë‚ ì§œ</label><input type="date" id="target-date"></div>
            <div><label style="font-size:0.65rem; font-weight:700; color:var(--text-sub);">ì˜¤ëŠ˜ ì²´ì¤‘(kg)</label><input type="number" id="daily-weight" step="0.1" placeholder="00.0"></div>
        </div>
        <div id="routine-list"></div>
        <button class="btn btn-success" style="margin-top:16px;" onclick="exportToExcel()">ğŸ“Š ì„ìƒ ë°ì´í„° Excel ì¶”ì¶œ</button>
    </div>
</div>

<!-- HELP MODAL -->
<div id="help-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>ğŸ”¬ 24h ì •ë°€ ëŒ€ì‚¬ ê°€ì´ë“œ</h2><button class="modal-close" onclick="toggleModal('help-modal')">&times;</button></div>
        <div id="modal-guide-body"></div>
    </div>
</div>

<script>
// ============================================================
// ğŸ”¥ FIREBASE CONFIGURATION
// ============================================================
// âš ï¸ ì•„ë˜ firebaseConfigë¥¼ ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
// Firebase Console > í”„ë¡œì íŠ¸ ì„¤ì • > ì¼ë°˜ > ë‚´ ì•± > Firebase SDK snippet
const firebaseConfig = {
    apiKey: "AIzaSyAmvW0gVPtybG43_nsPVXTNWFAA4MkTmk8",
    authDomain: "incretina-i-pro.firebaseapp.com",
    projectId: "incretina-i-pro",
    storageBucket: "incretina-i-pro.firebasestorage.app",
    messagingSenderId: "649157897211",
    appId: "1:649157897211:web:0f31b8985aad5f6d14795e",
    measurementId: "G-P3NVEW4S3Y"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence({ synchronizeTabs: true }).catch(err => {
    console.warn('Firestore persistence error:', err.code);
});

let currentUser = null;
let unsubProfile = null;
let unsubHistory = null;

// ============================================================
// AUTH FUNCTIONS
// ============================================================
function setLoading(on) {
    document.getElementById('status-bar').className = on ? 'auth-status-bar loading' : 'auth-status-bar';
    document.querySelectorAll('.auth-btn').forEach(b => b.disabled = on);
}

function showAuthError(msg) {
    document.getElementById('auth-error').textContent = msg;
    setTimeout(() => document.getElementById('auth-error').textContent = '', 5000);
}

function toggleAuthMode() {
    const login = document.getElementById('auth-login');
    const reg = document.getElementById('auth-register');
    login.style.display = login.style.display === 'none' ? 'block' : 'none';
    reg.style.display = reg.style.display === 'none' ? 'block' : 'none';
    document.getElementById('auth-error').textContent = '';
}

async function emailLogin() {
    const email = document.getElementById('auth-email').value.trim();
    const pw = document.getElementById('auth-pw').value;
    if (!email || !pw) return showAuthError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    setLoading(true);
    try {
        await auth.signInWithEmailAndPassword(email, pw);
    } catch (e) {
        const msgs = { 'auth/user-not-found': 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'auth/invalid-email': 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'auth/too-many-requests': 'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' };
        showAuthError(msgs[e.code] || e.message);
    }
    setLoading(false);
}

async function emailRegister() {
    const email = document.getElementById('reg-email').value.trim();
    const pw = document.getElementById('reg-pw').value;
    const pw2 = document.getElementById('reg-pw2').value;
    if (!email || !pw) return showAuthError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    if (pw.length < 6) return showAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if (pw !== pw2) return showAuthError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    setLoading(true);
    try {
        await auth.createUserWithEmailAndPassword(email, pw);
    } catch (e) {
        const msgs = { 'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'auth/invalid-email': 'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.' };
        showAuthError(msgs[e.code] || e.message);
    }
    setLoading(false);
}

async function guestLogin() {
    setLoading(true);
    try {
        await auth.signInAnonymously();
    } catch (e) {
        showAuthError('ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message);
    }
    setLoading(false);
}

async function doLogout() {
    if (unsubProfile) unsubProfile();
    if (unsubHistory) unsubHistory();
    await auth.signOut();
}

// Auth state observer
auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        const email = user.email || 'ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì';
        document.getElementById('user-email').textContent = email;
        document.getElementById('user-avatar').textContent = user.email ? user.email[0].toUpperCase() : 'G';
        initApp();
    } else {
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
        currentUser = null;
    }
});

// ============================================================
// FIRESTORE DATA LAYER
// ============================================================
function userDoc() { return db.collection('users').doc(currentUser.uid); }
function historyCollection() { return userDoc().collection('dailyRoutines'); }

async function saveProfileToCloud() {
    if (!currentUser) return;
    const p = {
        start: document.getElementById('p-start').value,
        h: document.getElementById('p-h').value,
        sw: document.getElementById('p-sw').value,
        cw: document.getElementById('p-cw').value,
        gw: document.getElementById('p-gw').value,
        isDiabetic: document.getElementById('p-diabetic').value,
        exercise: document.getElementById('p-exercise').value,
        lat: document.getElementById('p-lat').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        await userDoc().set(p, { merge: true });
        showSyncStatus('synced');
    } catch (e) {
        console.error('Profile save error:', e);
        showSyncStatus('offline');
    }
}

async function saveDailyToCloud() {
    if (!currentUser) return;
    const dateKey = document.getElementById('target-date').value;
    if (!dateKey) return;
    const checks = routine.map((_, i) => document.getElementById(`item-${i}`)?.classList.contains('checked') || false);
    const score = calculateScore();
    const imem = calculateIMEM();
    const data = {
        score, checks,
        weight: document.getElementById('daily-weight').value || '',
        alpha: imem.alpha, beta: imem.beta, gamma: imem.gamma,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
        await historyCollection().doc(dateKey).set(data);
        showSyncStatus('synced');
    } catch (e) {
        console.error('Daily save error:', e);
        showSyncStatus('offline');
    }
}

function showSyncStatus(status) {
    const badge = document.getElementById('sync-badge');
    if (status === 'synced') {
        badge.className = 'sync-badge';
        badge.innerHTML = '<span class="dot"></span> Cloud Synced';
    } else {
        badge.className = 'sync-badge offline';
        badge.innerHTML = '<span class="dot"></span> Offline';
    }
}

function listenToProfile() {
    if (unsubProfile) unsubProfile();
    unsubProfile = userDoc().onSnapshot(doc => {
        if (doc.exists) {
            const p = doc.data();
            if (p.start) document.getElementById('p-start').value = p.start;
            if (p.h) document.getElementById('p-h').value = p.h;
            if (p.sw) document.getElementById('p-sw').value = p.sw;
            if (p.cw) document.getElementById('p-cw').value = p.cw;
            if (p.gw) document.getElementById('p-gw').value = p.gw;
            if (p.isDiabetic) document.getElementById('p-diabetic').value = p.isDiabetic;
            if (p.exercise) document.getElementById('p-exercise').value = p.exercise;
            if (p.lat) document.getElementById('p-lat').value = p.lat;
        }
        showSyncStatus('synced');
    }, err => {
        console.warn('Profile listen error:', err);
        showSyncStatus('offline');
    });
}

function listenToHistory() {
    if (unsubHistory) unsubHistory();
    unsubHistory = historyCollection().onSnapshot(snapshot => {
        // Rebuild local cache for charts
        const hist = {};
        snapshot.forEach(doc => { hist[doc.id] = doc.data(); });
        window._cloudHistory = hist;
        
        // Load current date data
        const dateKey = document.getElementById('target-date').value;
        const data = hist[dateKey];
        routine.forEach((_, i) => {
            const el = document.getElementById(`item-${i}`);
            if (el) {
                if (data && data.checks && data.checks[i]) el.classList.add('checked');
                else el.classList.remove('checked');
            }
        });
        document.getElementById('daily-weight').value = (data && data.weight) ? data.weight : '';
        
        const score = calculateScore();
        updateIMEMDisplay();
        updateAIStatus(score);
        refreshStats(score);
        updateTrendChart();
        showSyncStatus('synced');
    }, err => {
        console.warn('History listen error:', err);
        showSyncStatus('offline');
    });
}

// ============================================================
// ROUTINE DATA
// ============================================================
const routine = [
    { t:"07:00", title:"ìƒì²´ ë¦¬ë“¬ ë¦¬ì…‹", icon:"ğŸŒ…", pts:8, imem:"Î±", action:"ê¸°ìƒ 10ë¶„ ë‚´ ì§ì‚¬ê´‘ì„  5ë¶„ + ë¬¼ 300ml", detail:"ë§ë§‰ìœ¼ë¡œ ìœ ì…ëœ í–‡ë¹›ì€ ë©œë¼í† ë‹Œì„ ì°¨ë‹¨í•˜ê³  ì„¸ë¡œí† ë‹Œ í•©ì„±ì„ ìœ ë„í•˜ì—¬ ë‡Œì˜ ìƒì²´ ì‹œê³„ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤." },
    { t:"08:30", title:"ì»¤í”¼ ëŒ€ì‚¬ ë¶€ìŠ¤íŠ¸", icon:"â˜•", pts:5, imem:"Î±", action:"ì—…ë¬´ ì‹œì‘ ì „ ë¬´ê°€ë‹¹ ë¸”ë™ì»¤í”¼ 1ì”", detail:"ì»¤í”¼ì˜ í´ë¡œë¡œê²ì‚°ì€ ì†Œì¥ í•˜ë¶€ L-ì„¸í¬ë¥¼ ìê·¹í•´ ë‚´ì¸ì„± GLP-1 ë¶„ë¹„ë¥¼ ì˜ˆì—´í•©ë‹ˆë‹¤." },
    { t:"09:00", title:"14h ë‹¨ì‹ í•´ì œ", icon:"ğŸ³", pts:7, imem:"Î±", action:"ì²« ìŒì‹ ì„­ì·¨ + 14ì‹œê°„ ê³µë³µ ë‹¬ì„±", detail:"14ì‹œê°„ ê³µë³µ í›„ ì¸ìŠë¦° ê°ìˆ˜ì„±ì´ ì •ì ì¼ ë•Œ AMPK íš¨ì†Œê°€ ê°•ë ¥í•˜ê²Œ í™œì„±í™”ë©ë‹ˆë‹¤." },
    { t:"11:00", title:"í˜¸ë¥´ëª¬ í”„ë¦¬ë¡œë“œ", icon:"ğŸ¥œ", pts:12, crit:true, imem:"Î²_pre", action:"ì ì‹¬ 30ë¶„ ì „ ë‹¨ë°±ì§ˆ 15g + ì‹ì´ì„¬ìœ  5g", detail:"ì‹ì´ì„¬ìœ ì™€ ë‹¨ë°±ì§ˆì´ ì†Œì¥ì— ë¨¼ì € ë„ì°©í•˜ë©´ GLP-1ì´ ì„ ì œ ë¶„ë¹„ë˜ì–´ í˜ˆë‹¹ ìŠ¤íŒŒì´í¬ë¥¼ ë°©ì–´í•©ë‹ˆë‹¤." },
    { t:"12:00", title:"ì¸í¬ë ˆí‹´ ì‹œí€€ìŠ¤", icon:"ğŸ¥—", pts:13, crit:true, imem:"Î²_seq", action:"ì±„ì†Œ â†’ ë‹¨ë°±ì§ˆ â†’ íƒ„ìˆ˜í™”ë¬¼ ìˆœì„œ ê³ ìˆ˜", detail:"ì˜ì–‘ì†Œ ì…ë ¥ ìˆœì„œë¥¼ ë°”ê¾¸ë©´ ìœ„ ë°°ì¶œ ì†ë„ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ì§€ì—°ë˜ì–´ ì¸ìŠë¦° ìŠ¤íŒŒì´í¬ë¥¼ ìµœì†Œí™”í•©ë‹ˆë‹¤." },
    { t:"12:50", title:"ê¸€ë£¨ì½”ìŠ¤ í´ë¦¬ì–´ëŸ°ìŠ¤", icon:"ğŸš¶", pts:13, crit:true, imem:"Î²_seq", action:"ì‹í›„ 40ë¶„ ì´ë‚´ ë¹ ë¥¸ ê±·ê¸° 30~40ë¶„", detail:"ê·¼ìœ¡ì˜ GLUT4 ìˆ˜ìš©ì²´ë¥¼ ê°•ì œ í™œì„±í™”í•˜ì—¬ í˜ˆì•¡ ì† í¬ë„ë‹¹ì„ ì§ì ‘ ì—°ì†Œì‹œí‚µë‹ˆë‹¤." },
    { t:"19:00", title:"ì €ë… ë§ˆê° (Metabolic Switch)", icon:"â°", pts:17, crit:true, imem:"Î±", action:"19ì‹œ ì´ì „ ë§ˆì§€ë§‰ ì‹ì‚¬ ì™„ë£Œ í›„ ë‹¨ì‹", detail:"ì¸ìŠë¦° ë†ë„ë¥¼ ê¸°ì € ìˆ˜ì¤€ìœ¼ë¡œ ë‚®ì¶”ì–´ ì‹ ì²´ë¥¼ ì§€ë°© ì—°ì†Œ ëª¨ë“œë¡œ ì „í™˜ì‹œí‚µë‹ˆë‹¤." },
    { t:"20:30", title:"ê·¼ìœ¡ ë°©ì–´ ë³´í˜¸ë§‰", icon:"ğŸ’ª", pts:10, imem:"Î³", action:"ìŠ¤ì¿¼íŠ¸ ë“± ëŒ€ê·¼ìœ¡ ì¤‘ì‹¬ ê·¼ë ¥ìš´ë™ 30ë¶„", detail:"ë§ˆì´ì˜¤ì¹´ì¸ì„ ë¶„ë¹„ì‹œì¼œ ì „ì‹ ì˜ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±(Î³)ì„ ë†’ì´ê³  ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ì €í•˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤." },
    { t:"22:00", title:"ë©œë¼í† ë‹Œ ì„¸ì´í”„ê°€ë“œ", icon:"ğŸŒ™", pts:8, imem:"Î±", action:"ë¸”ë£¨ë¼ì´íŠ¸ ì°¨ë‹¨ ë° ì‹¤ë‚´ ì¡°ë„ ë‚®ì¶”ê¸°", detail:"ë©œë¼í† ë‹Œ í•©ì„±ì„ ë„ì™€ ë‚´ì¼ ì•„ì¹¨ì˜ ëŒ€ì‚¬ ìœ ì—°ì„±ì„ ì¤€ë¹„í•©ë‹ˆë‹¤." },
    { t:"23:00", title:"ì‹¬ì¸µ ëŒ€ì‚¬ ë³µêµ¬", icon:"ğŸ˜´", pts:7, imem:"Î±", action:"ì™„ì „ ì•”ë§‰ í™˜ê²½ì—ì„œ 7~8ì‹œê°„ ìˆ™ë©´", detail:"ìˆ˜ë©´ ì¤‘ ë ™í‹´ì´ ì •ìƒí™”ë˜ê³  ì½”ë¥´í‹°ì†”ì´ ë‚®ì•„ì ¸ ë‹¤ìŒ ë‚  ì¸í¬ë ˆí‹´ ë¯¼ê°ë„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤." }
];

const nudges = {
    clinical: { master:"ìµœì ì˜ ì¸í¬ë ˆí‹´ íš¨ìœ¨(Î±={a}, Î²={b})ì´ ë‹¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. Î³={g}ë¡œ ê·¼ìœ¡ ë°©ì–´ë„ ì•ˆì •ì ì…ë‹ˆë‹¤.", achiever:"í˜„ì¬ Î±={a}ì…ë‹ˆë‹¤. ê³¨ë“ íƒ€ì„ ë‚´ ì‹ì‚¬ë¥¼ ì™„ë£Œí•˜ë©´ Î±=1.10 ìƒí–¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.", reset:"ëŒ€ì‚¬ ìŠ¤ìœ„ì¹˜ ì •ì²´(Î±={a}). 19:00 ì €ë… ë§ˆê°ìœ¼ë¡œ ì¸ìŠë¦° ê¸°ì €ì¹˜ë¥¼ í•˜í–¥ì‹œí‚¤ì„¸ìš”." },
    driver: { master:"ì™„ë²½! Î±={a} Ã— Î²={b} Ã— Î³={g} = {total}. ê³„ì† ë°€ì–´ë¶™ì´ì„¸ìš”!", achiever:"ì‹í›„ ì‚°ì±…(+13pt)ê³¼ í”„ë¦¬ë¡œë“œ(+12pt)ë¥¼ íƒ€í˜‘í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.", reset:"ê²½ê³ : ì¢…í•© íš¨ìœ¨ {total}. ì¦‰ì‹œ ì•¼ê°„ ë‹¨ì‹ ëª¨ë“œì— ì§„ì…í•˜ì„¸ìš”!" },
    empathetic: { master:"ì˜¤ëŠ˜ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”! í¸ì•ˆí•˜ê²Œ ìˆ™ë©´í•˜ì„¸ìš”. ğŸ˜Š", achiever:"ì ì‹¬ ì „ í”„ë¦¬ë¡œë“œ í•˜ë‚˜ë§Œ ë”í•˜ë©´ í›¨ì”¬ ê°€ë²¼ì›Œì§ˆ ê±°ì˜ˆìš”. í™”ì´íŒ…!", reset:"ì˜¤ëŠ˜ í˜ë“œì…¨ë‚˜ìš”? ë‚´ì¼ ì•„ì¹¨ í–‡ë¹› ë¦¬ì…‹ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ìš”. ğŸ’ª" }
};

// ============================================================
// BIO-SYNC TIMER
// ============================================================
let currentSunrise, currentSunset, isNightMode = false, themeManualOverride = false;

function calculateSunTimes(lat) {
    const d = new Date();
    const dayOfYear = Math.floor((d - new Date(d.getFullYear(),0,0)) / 86400000);
    const declination = 23.45 * Math.sin((2*Math.PI/365)*(dayOfYear-81));
    const latRad = lat * Math.PI/180, declRad = declination * Math.PI/180;
    let hourAngle = Math.acos(-Math.tan(latRad)*Math.tan(declRad)) * 180/Math.PI/15;
    const noon = 12.0;
    return { sunrise:{h:Math.floor(noon-hourAngle), m:Math.round(((noon-hourAngle)%1)*60)}, sunset:{h:Math.floor(noon+hourAngle), m:Math.round(((noon+hourAngle)%1)*60)} };
}
function timeToMinutes(h,m){return h*60+m;}
function minutesToStr(mins){return `${String(Math.floor(mins/60)).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`;}

function updateBioSyncTimer() {
    const lat = parseFloat(document.getElementById('p-lat').value)||37.5;
    const sun = calculateSunTimes(lat);
    currentSunrise=sun.sunrise; currentSunset=sun.sunset;
    document.getElementById('sunrise-time').textContent=minutesToStr(timeToMinutes(sun.sunrise.h,sun.sunrise.m));
    document.getElementById('sunset-time').textContent=minutesToStr(timeToMinutes(sun.sunset.h,sun.sunset.m));
    document.getElementById('location-label').textContent=`ğŸ“ ìœ„ë„ ${lat}Â°N`;
    const now=new Date(), nowMins=timeToMinutes(now.getHours(),now.getMinutes());
    const srMins=timeToMinutes(sun.sunrise.h,sun.sunrise.m), ssMins=timeToMinutes(sun.sunset.h,sun.sunset.m);
    const goldenTotal=ssMins-srMins;
    const modeBadge=document.getElementById('mode-badge'),goldenTitle=document.getElementById('golden-title'),goldenSub=document.getElementById('golden-sub');
    const ctTime=document.getElementById('countdown-time'),ctLabel=document.getElementById('countdown-label');
    const ring=document.getElementById('countdown-ring'),circ=301.6;
    const pBar=document.getElementById('golden-progress'),pPct=document.getElementById('golden-pct');
    const overlay=document.getElementById('fasting-overlay');

    if(nowMins>=srMins&&nowMins<ssMins){
        const elapsed=nowMins-srMins, remaining=ssMins-nowMins, pct=Math.round((elapsed/goldenTotal)*100);
        modeBadge.className='biosync-mode mode-day'; modeBadge.innerHTML='â˜€ï¸ DAY MODE â€” GOLDEN TIME';
        goldenTitle.textContent='ğŸŒ… ê³¨ë“ íƒ€ì„ ì§„í–‰ ì¤‘';
        if(remaining<=30){goldenSub.textContent='âš ï¸ ë¼ìŠ¤íŠ¸ì½œ! ë§ˆì§€ë§‰ ì‹ì‚¬ë¥¼ ì§€ê¸ˆ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”!'; goldenSub.style.color='var(--danger)'; ring.style.stroke='var(--danger)';}
        else if(remaining<=60){goldenSub.textContent='ğŸ”¶ ê³¨ë“ íƒ€ì„ ì¢…ë£Œ 1ì‹œê°„ ì „. ì €ë… ì‹ì‚¬ë¥¼ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.'; goldenSub.style.color='var(--accent)'; ring.style.stroke='var(--accent)';}
        else{goldenSub.textContent='ì¸í¬ë ˆí‹´ í˜¸ë¥´ëª¬ ë¶„ë¹„ê°€ í™œë°œí•œ ì‹œê°„ì…ë‹ˆë‹¤. ì´ ì‹œê°„ ì•ˆì— ì‹ì‚¬ë¥¼ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.'; goldenSub.style.color='var(--text-sub)'; ring.style.stroke='var(--success)';}
        ctTime.textContent=`${Math.floor(remaining/60)}h ${String(remaining%60).padStart(2,'0')}m`; ctLabel.textContent='ë‚¨ì€ ì‹œê°„';
        ring.style.strokeDashoffset=circ*(1-remaining/goldenTotal);
        pBar.style.width=pct+'%'; pBar.style.background='var(--golden-gradient)'; pPct.textContent=pct+'%';
        if(!themeManualOverride){setTheme('day'); overlay.classList.remove('active');} isNightMode=false;
    } else {
        modeBadge.className='biosync-mode mode-night'; modeBadge.innerHTML='ğŸŒ™ NIGHT MODE â€” ëŒ€ì‚¬ íœ´ì‹';
        goldenTitle.textContent='ğŸŒ™ ëŒ€ì‚¬ íœ´ì‹ ëª¨ë“œ'; goldenSub.textContent='ì•¼ê°„ ê³µë³µì„ ìœ ì§€í•˜ë©´ ë‚´ì¼ ì•„ì¹¨ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±ì´ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤.'; goldenSub.style.color='var(--text-sub)'; ring.style.stroke='#6366f1';
        let toSR=nowMins>=ssMins?(1440-nowMins)+srMins:srMins-nowMins;
        ctTime.textContent=`${Math.floor(toSR/60)}h ${String(toSR%60).padStart(2,'0')}m`; ctLabel.textContent='ì¼ì¶œê¹Œì§€';
        ring.style.strokeDashoffset=circ*0.2; pBar.style.width='100%'; pBar.style.background='linear-gradient(135deg,#6366f1,#3b82f6)'; pPct.textContent='ì™„ë£Œ';
        if(!themeManualOverride){setTheme('night'); overlay.classList.add('active');} isNightMode=true;
    }
}
function setTheme(mode){document.documentElement.setAttribute('data-theme',mode==='night'?'night':''); document.getElementById('theme-toggle').textContent=mode==='night'?'ğŸŒ™':'â˜€ï¸';}
function toggleThemeManual(){themeManualOverride=true; const isN=document.documentElement.getAttribute('data-theme')==='night'; setTheme(isN?'day':'night'); setTimeout(()=>{themeManualOverride=false;},30000);}

// ============================================================
// IMEM ENGINE
// ============================================================
function calculateIMEM(){
    const checks=routine.map((_,i)=>document.getElementById(`item-${i}`)?.classList.contains('checked')||false);
    let alpha=1.0;
    if(checks[6]){const ssMins=currentSunset?timeToMinutes(currentSunset.h,currentSunset.m):1080; alpha=ssMins>=1140?1.10:1.05;} else if(isNightMode){alpha=0.90;}
    if(checks[0])alpha+=0.02; if(checks[8]&&checks[9])alpha+=0.02;
    alpha=Math.round(alpha*100)/100;
    let beta_pre=checks[3]?1.025:1.0, beta_seq=(checks[4]&&checks[5])?1.025:(checks[4]?1.015:1.0);
    let beta=Math.round((beta_pre*beta_seq)*1000)/1000;
    const isDiabetic=document.getElementById('p-diabetic').value;
    const exCount=parseInt(document.getElementById('p-exercise').value)||0;
    let gamma_base=isDiabetic==='yes'?0.85:(isDiabetic==='pre'?0.95:1.00);
    let gamma_ex=exCount>=3&&checks[7]?0.05:(exCount>=3?0.03:(checks[7]?0.02:0));
    let gamma=Math.round((gamma_base*(1+gamma_ex))*100)/100;
    return {alpha,beta,gamma};
}
function updateIMEMDisplay(){
    const imem=calculateIMEM();
    document.getElementById('alpha-val').textContent=imem.alpha.toFixed(2);
    document.getElementById('beta-val').textContent=imem.beta.toFixed(3);
    document.getElementById('gamma-val').textContent=imem.gamma.toFixed(2);
    const aEl=document.getElementById('alpha-val');
    aEl.style.color=imem.alpha>=1.05?'var(--success)':(imem.alpha>=1.0?'var(--accent)':'var(--danger)');
    return imem;
}
function calculateScore(){return routine.reduce((s,item,i)=>s+(document.getElementById(`item-${i}`)?.classList.contains('checked')?item.pts:0),0);}
function updateAIStatus(score){
    if(score===undefined)score=calculateScore();
    const imem=calculateIMEM(), persona=document.getElementById('ai-persona').value;
    let state=score>=85?'master':(score>=55?'achiever':'reset');
    const total=(imem.alpha*imem.beta*imem.gamma).toFixed(3);
    let msg=nudges[persona][state].replace('{a}',imem.alpha.toFixed(2)).replace('{b}',imem.beta.toFixed(3)).replace('{g}',imem.gamma.toFixed(2)).replace('{total}',total);
    document.getElementById('ai-nudge').textContent=msg;
}
function refreshStats(score){
    const h=parseFloat(document.getElementById('p-h').value)/100, cw=parseFloat(document.getElementById('p-cw').value), sw=parseFloat(document.getElementById('p-sw').value), gw=parseFloat(document.getElementById('p-gw').value);
    if(h>0&&cw>0)document.getElementById('bmi-v').textContent=(cw/(h*h)).toFixed(1);
    if(sw&&gw&&cw&&sw!==gw){const ach=Math.max(0,Math.min(100,((sw-cw)/(sw-gw))*100)); const el=document.getElementById('ach-v'); el.textContent=ach.toFixed(1)+'%'; el.style.color=ach>=50?'var(--success)':(ach>=25?'var(--accent)':'var(--danger)');}
    if(score===undefined)score=calculateScore();
    document.getElementById('today-score').textContent=score;
    const imem=calculateIMEM(), eff=((imem.alpha*imem.beta*imem.gamma-1)*100), br=Math.max(0,Math.round(eff*10)/10);
    const bEl=document.getElementById('burn-rate'); bEl.textContent=(br>0?'+':'')+br.toFixed(1)+'%'; bEl.style.color=br>5?'var(--success)':(br>0?'var(--accent)':'var(--danger)');
}

// ============================================================
// RENDERING
// ============================================================
let simChart,trendChart;
const dateInput=document.getElementById('target-date');
dateInput.value=new Date().toISOString().split('T')[0];

function renderList(){
    document.getElementById('routine-list').innerHTML=routine.map((item,i)=>`
        <div class="item ${item.crit?'critical':''}" id="item-${i}" onclick="toggleTask(${i})">
            <div class="item-icon">${item.icon}</div>
            <div class="item-body">
                <span class="item-time">${item.t} Â· ${item.imem}</span>
                <span class="item-title">${item.title}</span>
                <span class="item-action">${item.action}</span>
            </div>
            <div class="score-badge">+${item.pts}</div>
        </div>`).join('');
}
function renderModalContent(){
    document.getElementById('modal-guide-body').innerHTML=routine.map(r=>`
        <div class="guide-step">
            <span class="guide-time">${r.icon} ${r.t}</span>
            <span class="guide-title">${r.title} <span style="font-size:0.7rem;color:var(--primary);font-weight:700;">[${r.imem}]</span></span>
            <div class="guide-box">
                <span class="guide-label">Action Protocol</span><p class="guide-text"><b>${r.action}</b></p>
                <span class="guide-label" style="margin-top:10px;">Clinical Mechanism</span><p class="guide-text" style="color:var(--primary);">${r.detail}</p>
            </div>
        </div>`).join('');
}
function toggleModal(id){const m=document.getElementById(id); m.style.display=m.style.display==='flex'?'none':'flex';}

function toggleTask(i){
    document.getElementById(`item-${i}`).classList.toggle('checked');
    onDataChange();
}
function onDataChange(){
    const score=calculateScore(); updateIMEMDisplay(); updateAIStatus(score); refreshStats(score);
    saveDailyToCloud(); saveProfileToCloud();
}

function updateTrendChart(){
    const hist=window._cloudHistory||{};
    const sorted=Object.keys(hist).sort();
    const wData=sorted.filter(d=>hist[d].weight).map(d=>({date:d.slice(5),weight:parseFloat(hist[d].weight)}));
    if(wData.length>0){
        document.getElementById('trend-view').style.display='block';
        const ctx=document.getElementById('trendChart').getContext('2d');
        if(trendChart)trendChart.destroy();
        trendChart=new Chart(ctx,{type:'line',data:{labels:wData.map(d=>d.date),datasets:[{data:wData.map(d=>d.weight),borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,0.08)',fill:true,tension:0.35,pointRadius:4,pointBackgroundColor:'#2563eb',borderWidth:2}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,0.05)'}},x:{grid:{display:false}}}}});
    }
}

function runComprehensiveAnalysis(){
    const cw=parseFloat(document.getElementById('p-cw').value), gw=parseFloat(document.getElementById('p-gw').value);
    const imem=calculateIMEM(), compliance=calculateScore()/100;
    const dailyDeficit=300, baseWeeklyLoss=(dailyDeficit*7)/7700;
    const mult=imem.alpha*imem.beta*imem.gamma;
    let labels=["í˜„ì¬"],weights=[cw],tmp=cw;
    for(let w=1;w<=4;w++){tmp-=((baseWeeklyLoss*mult*Math.max(compliance,0.5))+(w===1?0.5:0)); tmp=Math.max(tmp,gw); labels.push(w+"ì£¼"); weights.push(parseFloat(tmp.toFixed(1)));}
    document.getElementById('sim-view').style.display='block';
    const ctx=document.getElementById('simChart').getContext('2d');
    if(simChart)simChart.destroy();
    simChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:weights,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.08)',borderDash:[6,4],tension:0.4,fill:true,pointRadius:5,pointBackgroundColor:'#10b981',borderWidth:2}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,0.05)'}},x:{grid:{display:false}}}}});
    onDataChange();
}

function exportToExcel(){
    const hist=window._cloudHistory||{};
    const hVal=parseFloat(document.getElementById('p-h').value)/100;
    const data=Object.keys(hist).sort().map(date=>{const e=hist[date]; const w=parseFloat(e.weight)||0; return{"ë‚ ì§œ":date,"ë£¨í‹´ì ìˆ˜":e.score,"ì²´ì¤‘(kg)":w,"BMI":w>0?(w/(hVal*hVal)).toFixed(1):"-","Î±":e.alpha||"-","Î²":e.beta||"-","Î³":e.gamma||"-","IMEM":(e.alpha&&e.beta&&e.gamma)?(e.alpha*e.beta*e.gamma).toFixed(3):"-","ì‹¤ì²œë‚´ìš©":e.checks?e.checks.map((c,i)=>c?routine[i].title:null).filter(v=>v).join(", "):""};});
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"IMEM_Clinical_Log");
    XLSX.writeFile(wb,`IncretinAi_v3.1_CloudData.xlsx`);
}

// ============================================================
// INIT
// ============================================================
function initApp(){
    renderList(); renderModalContent();
    listenToProfile(); listenToHistory();
    updateBioSyncTimer();
    setInterval(updateBioSyncTimer,30000);
}

dateInput.addEventListener('change',()=>{
    const hist=window._cloudHistory||{};
    const data=hist[dateInput.value];
    routine.forEach((_,i)=>{const el=document.getElementById(`item-${i}`); if(data&&data.checks&&data.checks[i])el.classList.add('checked'); else el.classList.remove('checked');});
    document.getElementById('daily-weight').value=(data&&data.weight)?data.weight:'';
    const score=calculateScore(); updateIMEMDisplay(); updateAIStatus(score); refreshStats(score);
});
document.getElementById('daily-weight').addEventListener('input',()=>{saveDailyToCloud();});
document.getElementById('p-lat').addEventListener('change',()=>{updateBioSyncTimer(); saveProfileToCloud();});
document.getElementById('p-diabetic').addEventListener('change',onDataChange);
document.getElementById('p-exercise').addEventListener('change',onDataChange);
</script>
</body>
</html>
