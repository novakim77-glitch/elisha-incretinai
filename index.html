<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IncretinA i Pro v5.0 â€” Defense & Recovery Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@500;700&family=Noto+Sans+KR:wght@300;400;500;600&display=swap');
        :root {
            --bg:#f0f4f8;--surface:#fff;--surface-alt:#f7f9fc;--text:#0f172a;--text-sub:#64748b;
            --primary:#2563eb;--primary-glow:rgba(37,99,235,.15);--success:#10b981;--success-glow:rgba(16,185,129,.15);
            --danger:#ef4444;--danger-glow:rgba(239,68,68,.1);--accent:#f59e0b;--accent-glow:rgba(245,158,11,.15);
            --border:#e2e8f0;--shadow:0 8px 32px rgba(15,23,42,.06);--shadow-lg:0 16px 48px rgba(15,23,42,.1);
            --golden-gradient:linear-gradient(135deg,#f59e0b,#ef4444);--card-radius:24px;--transition:.5s cubic-bezier(.4,0,.2,1);
            --warning:#f97316;--warning-glow:rgba(249,115,22,.12);
        }
        [data-theme="night"]{
            --bg:#0c1222;--surface:#1a2236;--surface-alt:#151d30;--text:#e2e8f0;--text-sub:#94a3b8;
            --primary:#60a5fa;--primary-glow:rgba(96,165,250,.12);--success:#34d399;--success-glow:rgba(52,211,153,.12);
            --danger:#f87171;--danger-glow:rgba(248,113,113,.1);--accent:#fbbf24;--accent-glow:rgba(251,191,36,.12);
            --border:#2a3548;--shadow:0 8px 32px rgba(0,0,0,.3);--shadow-lg:0 16px 48px rgba(0,0,0,.4);
            --warning:#fb923c;--warning-glow:rgba(251,146,60,.12);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);padding:16px;display:flex;flex-direction:column;align-items:center;transition:background var(--transition),color var(--transition);min-height:100vh}
        .container{max-width:820px;width:100%}

        /* AUTH */
        .auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;width:100%;z-index:3000;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%)}
        .auth-card{background:rgba(255,255,255,.04);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08);border-radius:32px;padding:48px 36px;width:90%;max-width:420px;text-align:center}
        .auth-logo{margin-bottom:16px;display:flex;justify-content:center}.auth-title{font-size:1.5rem;font-weight:900;color:#e2e8f0;margin-bottom:4px;display:none}.auth-subtitle{font-size:.8rem;color:#94a3b8;margin-bottom:32px;font-weight:500}
        .auth-input{width:100%;padding:14px 18px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:#e2e8f0;font-family:'Outfit',sans-serif;font-size:.9rem;font-weight:500;margin-bottom:12px;transition:border-color .2s}
        .auth-input:focus{outline:none;border-color:#60a5fa}.auth-input::placeholder{color:#64748b}
        .auth-btn{width:100%;padding:15px;border-radius:14px;border:none;font-family:'Outfit',sans-serif;font-weight:800;font-size:.9rem;cursor:pointer;transition:transform .2s,opacity .2s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
        .auth-btn:hover{transform:translateY(-2px)}.auth-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .auth-btn-primary{background:#2563eb;color:#fff}.auth-btn-secondary{background:rgba(255,255,255,.06);color:#94a3b8;border:1px solid rgba(255,255,255,.1)}
        .auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:#475569;font-size:.75rem;font-weight:600}
        .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.08)}
        .auth-toggle{color:#60a5fa;font-size:.8rem;font-weight:600;cursor:pointer;margin-top:16px}.auth-toggle:hover{text-decoration:underline}
        .auth-error{color:#f87171;font-size:.78rem;font-weight:600;margin-bottom:12px;min-height:20px}
        .auth-status-bar{position:fixed;top:0;left:0;right:0;height:3px;z-index:3001;background:transparent;transition:background .3s}
        .auth-status-bar.loading{background:linear-gradient(90deg,#2563eb,#7c3aed,#2563eb);background-size:200%;animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

        /* SYNC & USER */
        .sync-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:.65rem;font-weight:700;background:var(--success-glow);color:var(--success)}
        .sync-badge.offline{background:var(--danger-glow);color:var(--danger)}.sync-badge .dot{width:6px;height:6px;border-radius:50%;background:currentColor}
        .user-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;width:100%;padding:0 4px}
        .user-info{display:flex;align-items:center;gap:8px}
        .user-avatar{width:30px;height:30px;border-radius:10px;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:.75rem;color:#fff;font-weight:800}
        .user-email{font-size:.72rem;color:var(--text-sub);font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .logout-btn{padding:5px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);font-family:'Outfit',sans-serif;font-size:.68rem;font-weight:700;color:var(--text-sub);cursor:pointer;transition:.2s}
        .logout-btn:hover{border-color:var(--danger);color:var(--danger)}

        /* HEADER */
        header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;width:100%}
        .logo{display:flex;align-items:center;gap:12px}
        .logo-icon{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#f97316,#fbbf24);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(249,115,22,.3)}
        [data-theme="night"] .logo-icon{background:linear-gradient(135deg,#f97316,#fbbf24);box-shadow:0 4px 16px rgba(249,115,22,.25)}
        .logo-text h1{font-size:1.25rem;font-weight:900;color:var(--text);line-height:1.2}.logo-text h1 .logo-i{color:#ea580c;font-weight:900}
        [data-theme="night"] .logo-text h1 .logo-i{color:#fb923c}
        .logo-text span{font-size:.6rem;font-weight:600;color:var(--text-sub);letter-spacing:1px}
        .header-actions{display:flex;gap:8px}
        .icon-btn{width:42px;height:42px;border-radius:14px;border:1px solid var(--border);background:var(--surface);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:.2s;color:var(--text)}
        .icon-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow)}

        /* BIO-SYNC */
        .biosync-card{background:var(--surface);border-radius:var(--card-radius);padding:28px;margin-bottom:20px;border:2px solid var(--border);box-shadow:var(--shadow);position:relative;overflow:hidden;width:100%;transition:border-color var(--transition),background var(--transition)}
        .biosync-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--golden-gradient)}
        [data-theme="night"] .biosync-card{border-color:#2a3548}[data-theme="night"] .biosync-card::before{background:linear-gradient(135deg,#3b82f6,#6366f1)}
        .biosync-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px}
        .biosync-mode{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:.72rem;font-weight:800;letter-spacing:.5px}
        .mode-day{background:#fef3c7;color:#92400e}.mode-night{background:#1e1b4b;color:#a5b4fc}
        .biosync-location{font-size:.7rem;color:var(--text-sub);font-weight:600}
        .golden-time-display{display:flex;align-items:center;gap:24px;margin-bottom:20px}
        .countdown-ring{width:110px;height:110px;position:relative;flex-shrink:0}.countdown-ring svg{transform:rotate(-90deg)}
        .countdown-ring .ring-bg{fill:none;stroke:var(--border);stroke-width:6}.countdown-ring .ring-progress{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset 1s linear,stroke .5s}
        .countdown-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
        .countdown-time{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--text);display:block}
        .countdown-label{font-size:.55rem;font-weight:700;color:var(--text-sub);letter-spacing:1px;text-transform:uppercase}
        .golden-info{flex:1}.golden-info .gi-title{font-size:.95rem;font-weight:800;color:var(--text);margin-bottom:6px}
        .golden-info .gi-sub{font-size:.78rem;color:var(--text-sub);line-height:1.5}
        .sun-times{display:flex;gap:16px;margin-top:10px}.sun-time{display:flex;align-items:center;gap:5px;font-size:.72rem;font-weight:700;color:var(--text-sub)}
        .sun-time span{font-family:'JetBrains Mono',monospace;color:var(--text)}
        .biosync-progress{background:var(--surface-alt);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px}
        .progress-bar-wrap{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
        .progress-bar-fill{height:100%;border-radius:4px;transition:width 1s ease,background .5s}
        .progress-pct{font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;min-width:42px;text-align:right}

        /* BATTERY GAUGE â€” v4.0 NEW */
        .gauge-card{background:var(--surface);border-radius:var(--card-radius);padding:24px;margin-bottom:20px;border:2px solid var(--border);box-shadow:var(--shadow);width:100%;transition:background var(--transition),border-color var(--transition)}
        .gauge-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
        .gauge-title{font-size:.75rem;font-weight:800;color:var(--text-sub);letter-spacing:1px;text-transform:uppercase}
        .gauge-score-big{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:700;text-align:center;margin-bottom:4px}
        .gauge-bar-outer{width:100%;height:28px;border-radius:14px;background:var(--surface-alt);border:1px solid var(--border);overflow:hidden;position:relative;margin-bottom:12px}
        .gauge-bar-inner{height:100%;border-radius:14px;transition:width .6s ease,background .4s;display:flex;align-items:center;justify-content:flex-end;padding-right:8px}
        .gauge-bar-label{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;color:#fff}
        .gauge-legend{display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
        .gauge-legend-item{display:flex;align-items:center;gap:5px;font-size:.68rem;font-weight:700;color:var(--text-sub)}
        .gauge-legend-dot{width:8px;height:8px;border-radius:50%}

        /* STATS */
        .stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px;width:100%}
        .stat-item{background:var(--surface);padding:16px 12px;border-radius:18px;text-align:center;border:1px solid var(--border);box-shadow:var(--shadow);transition:background var(--transition),border-color var(--transition)}
        .stat-val{display:block;font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;color:var(--primary)}
        .stat-lbl{font-size:.6rem;font-weight:700;color:var(--text-sub);margin-bottom:4px;display:block;letter-spacing:.5px;text-transform:uppercase}

        /* IMEM */
        .imem-card{background:var(--surface);border-radius:var(--card-radius);padding:24px;margin-bottom:20px;border:1px solid var(--border);box-shadow:var(--shadow);width:100%;transition:background var(--transition),border-color var(--transition)}
        .imem-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .imem-title{font-size:.75rem;font-weight:800;color:var(--text-sub);letter-spacing:1px;text-transform:uppercase}
        .imem-coefficients{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
        .coeff-item{background:var(--surface-alt);border-radius:14px;padding:14px;text-align:center;border:1px solid var(--border)}
        .coeff-symbol{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;display:block;margin-bottom:2px}
        .coeff-value{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700;display:block}
        .coeff-label{font-size:.6rem;font-weight:700;color:var(--text-sub);letter-spacing:.5px}
        .coeff-penalty{font-size:.6rem;font-weight:700;color:var(--danger);margin-top:2px;display:block}

        /* AI */
        .ai-card{background:var(--surface);border-radius:var(--card-radius);padding:24px;margin-bottom:20px;border:2px solid var(--primary);box-shadow:0 8px 32px var(--primary-glow);width:100%;transition:background var(--transition),border-color var(--transition)}
        .ai-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
        .ai-title{font-weight:800;color:var(--primary);font-size:.9rem;display:flex;align-items:center;gap:8px}
        .ai-persona-select{border:1px solid var(--border);border-radius:10px;padding:5px 10px;font-family:'Outfit',sans-serif;font-weight:700;font-size:.72rem;background:var(--surface-alt);color:var(--text);cursor:pointer}
        .ai-content{background:var(--surface-alt);padding:16px;border-radius:14px;font-size:.88rem;line-height:1.7;border-left:4px solid var(--primary);color:var(--text-sub);font-weight:500}

        /* CHARTS */
        .dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;width:100%}
        .chart-card{background:var(--surface);border-radius:var(--card-radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow);transition:background var(--transition),border-color var(--transition)}
        .chart-title{font-size:.7rem;font-weight:800;margin-bottom:10px;display:block;color:var(--text-sub);letter-spacing:.5px;text-transform:uppercase}

        /* INPUTS */
        .glass-card{background:var(--surface);border-radius:var(--card-radius);padding:24px;box-shadow:var(--shadow);margin-bottom:20px;width:100%;border:1px solid var(--border);transition:background var(--transition),border-color var(--transition)}
        .section-label{font-size:.7rem;font-weight:800;color:var(--text-sub);letter-spacing:1px;text-transform:uppercase;margin-bottom:14px;display:block}
        .profile-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px}
        .input-group label{font-size:.65rem;font-weight:700;color:var(--text-sub);display:block;margin-bottom:5px}
        input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-family:'Outfit',sans-serif;font-weight:600;font-size:.85rem;background:var(--surface-alt);color:var(--text);transition:border-color .2s}
        input:focus,select:focus{outline:none;border-color:var(--primary)}

        /* ROUTINE ITEMS */
        .routine-date-bar{display:flex;gap:10px;align-items:flex-end;margin-bottom:16px}.routine-date-bar>div{flex:1}
        .item{background:var(--surface);border-radius:18px;padding:16px 18px;margin-bottom:10px;display:flex;gap:14px;align-items:center;border-left:5px solid var(--border);cursor:pointer;transition:all .25s ease;position:relative}
        .item:hover{transform:translateX(4px)}.item.checked{background:var(--success-glow);border-left-color:var(--success)}
        .item.critical{border-left-color:var(--danger)}.item.critical.checked{border-left-color:var(--success)}
        .item-icon{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;background:var(--surface-alt);flex-shrink:0}
        .item.checked .item-icon{background:var(--success)}
        .item-body{flex:1;min-width:0}.item-time{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;color:var(--primary)}
        .item-title{font-size:.9rem;font-weight:800;color:var(--text);margin:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .item-action{font-size:.72rem;color:var(--text-sub);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .score-badge{background:var(--surface-alt);padding:4px 10px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;color:var(--text-sub);flex-shrink:0}
        .item.checked .score-badge{background:var(--success);color:#fff}

        /* INLINE TABS â€” v4.0 UPDATED */
        .routine-tabs{display:flex;gap:6px;margin-bottom:18px;background:var(--surface-alt);border-radius:16px;padding:5px;border:1px solid var(--border)}
        .routine-tab{flex:1;padding:12px 16px;border-radius:12px;border:none;font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:800;cursor:pointer;transition:all .25s ease;display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text-sub);background:transparent}
        .routine-tab:hover{background:rgba(0,0,0,.03)}
        [data-theme="night"] .routine-tab:hover{background:rgba(255,255,255,.04)}
        .routine-tab.active{color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.12)}
        .routine-tab.active.tab-plus{background:linear-gradient(135deg,#10b981,#059669)}
        .routine-tab.active.tab-minus{background:linear-gradient(135deg,#ef4444,#dc2626)}
        .tab-count{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;opacity:.85}
        .tab-badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:11px;font-family:'JetBrains Mono',monospace;font-size:.68rem;font-weight:800;padding:0 6px}
        .tab-badge.has-risks{background:#ef4444;color:#fff;animation:badgePulse 2s infinite}
        .tab-badge:not(.has-risks){background:var(--border);color:var(--text-sub)}
        .routine-tab.active .tab-badge.has-risks{background:rgba(255,255,255,.3);color:#fff}
        .routine-tab.active .tab-badge:not(.has-risks){background:rgba(255,255,255,.2);color:rgba(255,255,255,.7)}
        @keyframes badgePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
        .tab-content{display:none;animation:tabFadeIn .3s ease}
        .tab-content.active{display:block}
        @keyframes tabFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        /* RISK ITEMS â€” v4.0 */
        .risk-item{background:var(--surface);border-radius:18px;padding:16px 18px;margin-bottom:10px;display:flex;gap:14px;align-items:center;border-left:5px solid var(--border);cursor:pointer;transition:all .25s ease;opacity:.6}
        .risk-item:hover{transform:translateX(4px);opacity:.8}
        .risk-item.active{background:var(--danger-glow);border-left-color:var(--danger);opacity:1}
        .risk-item .item-icon{background:var(--surface-alt)}.risk-item.active .item-icon{background:var(--danger)}
        .risk-item .score-badge{color:var(--text-sub)}.risk-item.active .score-badge{background:var(--danger);color:#fff}

        /* RECOVERY POPUP â€” v4.0 NEW */
        .recovery-popup{display:none;position:fixed;bottom:0;left:0;right:0;z-index:2500;padding:16px;animation:slideUp .4s ease}
        .recovery-popup.show{display:block}
        @keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
        .recovery-card{max-width:500px;margin:0 auto;background:var(--surface);border-radius:24px;padding:24px;box-shadow:var(--shadow-lg);border:2px solid var(--warning)}
        .recovery-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .recovery-title{font-size:.9rem;font-weight:800;color:var(--warning);display:flex;align-items:center;gap:6px}
        .recovery-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-sub)}
        .recovery-body{margin-bottom:16px}
        .recovery-penalty{background:var(--danger-glow);border-radius:12px;padding:12px;margin-bottom:10px;font-size:.82rem;color:var(--danger);font-weight:700;display:flex;align-items:center;gap:8px}
        .recovery-mission{background:var(--success-glow);border-radius:12px;padding:12px;font-size:.82rem;color:var(--success);font-weight:600;line-height:1.5}
        .recovery-actions{display:flex;gap:10px}
        .recovery-btn{flex:1;padding:12px;border-radius:14px;border:none;font-family:'Outfit',sans-serif;font-weight:800;font-size:.82rem;cursor:pointer;transition:transform .2s}
        .recovery-btn:hover{transform:translateY(-2px)}
        .recovery-btn-do{background:var(--success);color:#fff;box-shadow:0 4px 16px var(--success-glow)}
        .recovery-btn-skip{background:var(--surface-alt);color:var(--text-sub);border:1px solid var(--border)}

        /* FASTING */
        .fasting-overlay{display:none;background:var(--surface-alt);border-radius:18px;padding:28px;text-align:center;margin-bottom:20px;border:1px dashed var(--border)}
        .fasting-overlay.active{display:block}.fasting-overlay .fo-icon{font-size:2.5rem;margin-bottom:10px}
        .fasting-overlay .fo-title{font-size:1rem;font-weight:800;color:var(--text);margin-bottom:6px}
        .fasting-overlay .fo-sub{font-size:.8rem;color:var(--text-sub);line-height:1.6}

        .btn{padding:14px 20px;border-radius:14px;border:none;font-family:'Outfit',sans-serif;font-weight:800;font-size:.85rem;cursor:pointer;color:#fff;text-align:center;transition:transform .2s,box-shadow .2s;display:block;width:100%}
        .btn:hover{transform:translateY(-2px)}
        .btn-primary{background:var(--primary);box-shadow:0 4px 16px var(--primary-glow)}
        .btn-success{background:var(--success);box-shadow:0 4px 16px var(--success-glow)}

        /* MODAL */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:2000;justify-content:center;align-items:center}
        .modal-content{background:var(--surface);width:95%;max-width:680px;padding:32px;border-radius:28px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
        .modal-header h2{font-size:1.2rem;font-weight:900;color:var(--primary)}.modal-close{background:var(--surface-alt);border:none;width:36px;height:36px;border-radius:10px;font-size:1.2rem;cursor:pointer;color:var(--text)}
        .guide-step{margin-bottom:22px;padding-bottom:18px;border-bottom:1px solid var(--border)}.guide-step:last-child{border-bottom:none}
        .guide-time{font-family:'JetBrains Mono',monospace;color:var(--primary);font-weight:700;font-size:.85rem}
        .guide-title{font-size:1rem;font-weight:800;color:var(--text);margin:4px 0 10px;display:block}
        .guide-box{background:var(--surface-alt);padding:14px;border-radius:14px;border-left:4px solid var(--accent)}
        .guide-label{font-size:.65rem;font-weight:800;color:var(--text-sub);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;display:block}
        .guide-text{font-size:.82rem;line-height:1.65;color:var(--text-sub)}.guide-text b{color:var(--text)}

        /* MAIN NAV â€” v5.0 */
        .main-nav{display:flex;gap:4px;margin-bottom:20px;background:var(--surface);border-radius:16px;padding:4px;border:1px solid var(--border);width:100%}
        .main-nav-tab{flex:1;padding:12px 8px;border-radius:12px;border:none;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text-sub);transition:all .25s;text-align:center;display:flex;align-items:center;justify-content:center;gap:4px}
        .main-nav-tab:hover{background:rgba(0,0,0,.04)}
        [data-theme="night"] .main-nav-tab:hover{background:rgba(255,255,255,.04)}
        .main-nav-tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 12px var(--primary-glow)}
        .main-nav-tab.popup-trigger{position:relative}
        .main-nav-tab.popup-trigger.active{background:linear-gradient(135deg,#7c3aed,#6366f1);box-shadow:0 4px 12px rgba(124,58,237,.2)}
        .main-page{display:none;width:100%}
        .main-page.active{display:block;animation:tabFadeIn .3s ease}

        /* GUIDE POPUP â€” v5.0 */
        .guide-popup-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:2500}
        .guide-popup-overlay.show{display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .guide-popup-card{width:100%;max-width:500px;background:var(--surface);border-radius:24px 24px 0 0;padding:24px;box-shadow:var(--shadow-lg);border-top:3px solid var(--accent);max-height:70vh;overflow-y:auto;animation:slideUp .4s ease}
        .guide-popup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .guide-popup-title{font-size:.95rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:8px}
        .guide-popup-close{background:var(--surface-alt);border:none;width:32px;height:32px;border-radius:10px;font-size:1.1rem;cursor:pointer;color:var(--text-sub);transition:.2s}
        .guide-popup-close:hover{background:var(--danger-glow);color:var(--danger)}

        /* GUIDE ICON BTN â€” v5.0 */
        .guide-btn{width:30px;height:30px;border-radius:10px;border:1px solid var(--border);background:var(--surface-alt);cursor:pointer;font-size:.8rem;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;color:var(--text-sub)}
        .guide-btn:hover{border-color:var(--accent);background:var(--accent-glow);color:var(--accent);transform:scale(1.1)}

        /* AI MODAL â€” v5.0 */
        .ai-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:2000;justify-content:center;align-items:center}
        .ai-modal.show{display:flex;animation:fadeIn .2s ease}
        .ai-modal-content{background:var(--surface);width:92%;max-width:500px;padding:28px;border-radius:28px;box-shadow:var(--shadow-lg);border:2px solid var(--primary);animation:slideUp .4s ease}
        .ai-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .ai-modal-header h2{font-size:1.1rem;font-weight:900;color:var(--primary);display:flex;align-items:center;gap:8px}
        .ai-modal-close{background:var(--surface-alt);border:none;width:36px;height:36px;border-radius:10px;font-size:1.2rem;cursor:pointer;color:var(--text)}

        @media(max-width:600px){
            .stat-grid{grid-template-columns:repeat(2,1fr)}.dashboard-grid{grid-template-columns:1fr}
            .golden-time-display{flex-direction:column;align-items:flex-start;gap:14px}.countdown-ring{align-self:center}
            .auth-card{padding:32px 24px}
            .main-nav-tab{font-size:.68rem;padding:10px 4px}
        }
        @media print{.no-print{display:none!important}}
    </style>
</head>
<body>

<div class="auth-status-bar" id="status-bar"></div>

<!-- AUTH SCREEN -->
<div class="auth-screen" id="auth-screen">
    <div class="auth-card">
        <div class="auth-logo">
            <svg width="280" height="80" viewBox="0 0 460 130" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="auth-sun" x1="0%" y1="100%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#f97316"/>
                        <stop offset="50%" stop-color="#fb923c"/>
                        <stop offset="100%" stop-color="#fbbf24"/>
                    </linearGradient>
                    <filter id="auth-glow">
                        <feGaussianBlur stdDeviation="2" result="b"/>
                        <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                <text x="230" y="72" text-anchor="middle"
                      font-family="Outfit, sans-serif" font-size="60" font-weight="700"
                      fill="#ffffff" letter-spacing="-0.5">IncretinAi</text>
                <rect x="389" y="12" width="16" height="22" fill="#161e2f" rx="2"/>
                <g transform="translate(397, 22)" filter="url(#auth-glow)">
                    <path d="M -10 0 A 10 10 0 0 1 10 0 Z" fill="url(#auth-sun)"/>
                    <path d="M -16 0 Q -10 -3.5, -5 0 Q 0 3.5, 5 0 Q 10 -3.5, 16 0"
                          fill="none" stroke="#fbbf24" stroke-width="1.2" stroke-linecap="round" opacity="0.4"/>
                </g>
                <text x="230" y="110" text-anchor="middle"
                      font-family="'Noto Sans KR', sans-serif" font-size="18" font-weight="500"
                      fill="#666" letter-spacing="4">ì¸í¬ë ˆí‹°ë‚˜ ì•„ì´</text>
            </svg>
        </div>
        <div class="auth-title">IncretinA i Pro</div>
        <div class="auth-subtitle">v5.0 Defense & Recovery Edition</div>
        <div class="auth-error" id="auth-error"></div>
        <div id="auth-login">
            <input class="auth-input" type="email" id="auth-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" autocomplete="email">
            <input class="auth-input" type="password" id="auth-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="current-password">
            <button class="auth-btn auth-btn-primary" onclick="emailLogin()">ğŸ” ë¡œê·¸ì¸</button>
            <div class="auth-divider">ë˜ëŠ”</div>
            <button class="auth-btn auth-btn-secondary" onclick="guestLogin()">ğŸ‘¤ ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘í•˜ê¸°</button>
            <div class="auth-toggle" onclick="toggleAuthMode()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <b>íšŒì›ê°€ì…</b></div>
        </div>
        <div id="auth-register" style="display:none;">
            <input class="auth-input" type="email" id="reg-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" autocomplete="email">
            <input class="auth-input" type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" autocomplete="new-password">
            <input class="auth-input" type="password" id="reg-pw2" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">
            <button class="auth-btn auth-btn-primary" onclick="emailRegister()">âœ¨ íšŒì›ê°€ì…</button>
            <div class="auth-toggle" onclick="toggleAuthMode()">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <b>ë¡œê·¸ì¸</b></div>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div class="container" id="app-container" style="display:none;">

    <div class="user-bar no-print">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">?</div>
            <div>
                <div class="user-email" id="user-email">-</div>
                <div class="sync-badge" id="sync-badge"><span class="dot"></span> Cloud Sync</div>
            </div>
        </div>
        <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <header>
        <div class="logo">
            <div class="logo-icon">
                <svg width="28" height="28" viewBox="-18 -12 36 14" xmlns="http://www.w3.org/2000/svg">
                    <path d="M -10 0 A 10 10 0 0 1 10 0 Z" fill="#fff"/>
                    <path d="M -16 0 Q -10 -3.5, -5 0 Q 0 3.5, 5 0 Q 10 -3.5, 16 0"
                          fill="none" stroke="#fff" stroke-width="1.2" stroke-linecap="round" opacity="0.5"/>
                </svg>
            </div>
            <div class="logo-text"><h1>IncretinA<span class="logo-i">i</span></h1><span>v5.0 DEFENSE & RECOVERY</span></div>
        </div>
        <div class="header-actions no-print">
            <button class="icon-btn" onclick="toggleThemeManual()" id="theme-toggle">â˜€ï¸</button>
        </div>
    </header>

    <!-- â˜… MAIN NAV â€” v5.0 â˜… -->
    <div class="main-nav no-print">
        <button class="main-nav-tab active" id="nav-dashboard" onclick="switchMainTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
        <button class="main-nav-tab" id="nav-routine" onclick="switchMainTab('routine')">ğŸ“ ë£¨í‹´ ê¸°ë¡</button>
        <button class="main-nav-tab" id="nav-profile" onclick="switchMainTab('profile')">âš™ï¸ í”„ë¡œí•„ ë¶„ì„</button>
        <button class="main-nav-tab popup-trigger" id="nav-ai" onclick="showAINudgeModal()">ğŸ§  AI ë„›ì§€</button>
    </div>

    <!-- â˜… PAGE: DASHBOARD â˜… -->
    <div class="main-page active" id="page-dashboard">

    <!-- Bio-Sync Timer -->
    <div class="biosync-card" id="biosync-card">
        <div class="biosync-header">
            <div class="biosync-mode mode-day" id="mode-badge">â˜€ï¸ DAY MODE â€” GOLDEN TIME</div>
            <div class="biosync-location" id="location-label">ğŸ“ ì„œìš¸ (37.5Â°N)</div>
        </div>
        <div class="golden-time-display">
            <div class="countdown-ring">
                <svg width="110" height="110" viewBox="0 0 110 110">
                    <circle class="ring-bg" cx="55" cy="55" r="48"/>
                    <circle class="ring-progress" id="countdown-ring" cx="55" cy="55" r="48" stroke-dasharray="301.6" stroke-dashoffset="0" stroke="var(--accent)"/>
                </svg>
                <div class="countdown-center">
                    <span class="countdown-time" id="countdown-time">--:--</span>
                    <span class="countdown-label" id="countdown-label">ë‚¨ì€ ì‹œê°„</span>
                </div>
            </div>
            <div class="golden-info">
                <div class="gi-title" id="golden-title">ğŸŒ… ê³¨ë“ íƒ€ì„ ì§„í–‰ ì¤‘</div>
                <div class="gi-sub" id="golden-sub">ì¸í¬ë ˆí‹´ í˜¸ë¥´ëª¬ ë¶„ë¹„ê°€ í™œë°œí•œ ì‹œê°„ì…ë‹ˆë‹¤.</div>
                <div class="sun-times">
                    <div class="sun-time">ğŸŒ… ì¼ì¶œ <span id="sunrise-time">--:--</span></div>
                    <div class="sun-time">ğŸŒ‡ ì¼ëª° <span id="sunset-time">--:--</span></div>
                </div>
            </div>
        </div>
        <div class="biosync-progress">
            <span style="font-size:.7rem;font-weight:700;color:var(--text-sub)">ê³¨ë“ íƒ€ì„</span>
            <div class="progress-bar-wrap"><div class="progress-bar-fill" id="golden-progress" style="width:0%;background:var(--golden-gradient)"></div></div>
            <span class="progress-pct" id="golden-pct">0%</span>
        </div>
    </div>

    <!-- â˜… BATTERY GAUGE â€” v4.0 NEW â˜… -->
    <div class="gauge-card" id="gauge-card">
        <div class="gauge-header">
            <span class="gauge-title">ğŸ”‹ ì¸í¬ë ˆí‹´ ê²Œì´ì§€ (Defense & Recovery)</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700;color:var(--text-sub)" id="gauge-detail">+0 / -0</span>
        </div>
        <div class="gauge-score-big" id="gauge-score" style="color:var(--success)">100</div>
        <div class="gauge-bar-outer">
            <div class="gauge-bar-inner" id="gauge-bar" style="width:100%;background:linear-gradient(90deg,#22c55e,#10b981)">
                <span class="gauge-bar-label" id="gauge-bar-pct">100%</span>
            </div>
        </div>
        <div class="gauge-legend">
            <div class="gauge-legend-item"><span class="gauge-legend-dot" style="background:#ef4444"></span>ìœ„í—˜ (&lt;30)</div>
            <div class="gauge-legend-item"><span class="gauge-legend-dot" style="background:#f97316"></span>ì£¼ì˜ (30~49)</div>
            <div class="gauge-legend-item"><span class="gauge-legend-dot" style="background:#f59e0b"></span>ê°œì„  (50~69)</div>
            <div class="gauge-legend-item"><span class="gauge-legend-dot" style="background:#22c55e"></span>ì–‘í˜¸ (70~84)</div>
            <div class="gauge-legend-item"><span class="gauge-legend-dot" style="background:#3b82f6"></span>ìµœì  (85+)</div>
        </div>
    </div>

    <div class="stat-grid no-print">
        <div class="stat-item"><span class="stat-lbl">í˜„ì¬ BMI</span><span class="stat-val" id="bmi-v">0.0</span></div>
        <div class="stat-item"><span class="stat-lbl">ëª©í‘œ ë‹¬ì„±ë¥ </span><span class="stat-val" id="ach-v" style="color:var(--danger)">0%</span></div>
        <div class="stat-item"><span class="stat-lbl">í˜ë„í‹° í•©ê³„</span><span class="stat-val" id="penalty-total" style="color:var(--danger)">0</span></div>
        <div class="stat-item"><span class="stat-lbl">íšŒë³µ í•©ê³„</span><span class="stat-val" id="recovery-total" style="color:var(--success)">0</span></div>
    </div>

    <div class="imem-card">
        <div class="imem-header"><span class="imem-title">ğŸ“ IMEM v2.0 ì‹¤ì‹œê°„ ê³„ìˆ˜ (í˜ë„í‹° ë°˜ì˜)</span></div>
        <div class="imem-coefficients">
            <div class="coeff-item">
                <span class="coeff-symbol" style="color:var(--accent)">Î±</span>
                <span class="coeff-value" id="alpha-val" style="color:var(--accent)">1.00</span>
                <span class="coeff-label">Timing</span>
                <span class="coeff-penalty" id="alpha-penalty"></span>
            </div>
            <div class="coeff-item">
                <span class="coeff-symbol" style="color:var(--primary)">Î²</span>
                <span class="coeff-value" id="beta-val" style="color:var(--primary)">1.00</span>
                <span class="coeff-label">Sequence</span>
                <span class="coeff-penalty" id="beta-penalty"></span>
            </div>
            <div class="coeff-item">
                <span class="coeff-symbol" style="color:var(--success)">Î³</span>
                <span class="coeff-value" id="gamma-val" style="color:var(--success)">1.00</span>
                <span class="coeff-label">Sensitivity</span>
                <span class="coeff-penalty" id="gamma-penalty"></span>
            </div>
        </div>
        <div style="background:var(--surface-alt);border-radius:12px;padding:12px 16px;font-size:.75rem;color:var(--text-sub);font-family:'JetBrains Mono',monospace;text-align:center">
            Î”Weight = f(BMR) Ã— [<span style="color:var(--accent);font-weight:700">Î±_net</span> Ã— <span style="color:var(--primary);font-weight:700">Î²_net</span> Ã— <span style="color:var(--success);font-weight:700">Î³_net</span>] Ã— Compliance
        </div>
    </div>

    </div><!-- /page-dashboard -->

    <!-- â˜… PAGE: ROUTINE â˜… -->
    <div class="main-page" id="page-routine">

    <div class="fasting-overlay" id="fasting-overlay">
        <div class="fo-icon">ğŸŒ™</div>
        <div class="fo-title">ëŒ€ì‚¬ íœ´ì‹ ëª¨ë“œ (Metabolic Rest)</div>
        <div class="fo-sub">ê³¨ë“ íƒ€ì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•¼ê°„ ê³µë³µì„ ìœ ì§€í•˜ë©´ ë‚´ì¼ ì•„ì¹¨ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±ì´ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤. ğŸ”¥</div>
    </div>

    <div class="glass-card no-print" id="routine-section">
        <div class="routine-date-bar">
            <div><label style="font-size:.65rem;font-weight:700;color:var(--text-sub)">ê¸°ë¡ ë‚ ì§œ</label><input type="date" id="target-date"></div>
            <div><label style="font-size:.65rem;font-weight:700;color:var(--text-sub)">ì˜¤ëŠ˜ ì²´ì¤‘(kg)</label><input type="number" id="daily-weight" step="0.1" placeholder="00.0"></div>
        </div>

        <!-- â˜… INLINE TAB SWITCHER â€” v5.0 â˜… -->
        <div class="routine-tabs">
            <button class="routine-tab tab-plus active" id="tab-plus" onclick="switchTab('plus')">
                â¬† í”ŒëŸ¬ìŠ¤ ë£¨í‹´ <span class="tab-count" id="tab-plus-count">(0/10)</span>
            </button>
            <button class="routine-tab tab-minus" id="tab-minus" onclick="switchTab('minus')">
                â¬‡ ë§ˆì´ë„ˆìŠ¤ ë£¨í‹´ <span class="tab-badge" id="tab-minus-badge">0</span>
            </button>
        </div>

        <!-- Tab Content: í”ŒëŸ¬ìŠ¤ ë£¨í‹´ -->
        <div class="tab-content active" id="tab-content-plus">
            <div id="routine-list"></div>
        </div>

        <!-- Tab Content: ë§ˆì´ë„ˆìŠ¤ ë£¨í‹´ -->
        <div class="tab-content" id="tab-content-minus">
            <div id="risk-list"></div>
        </div>

        <button class="btn btn-success" style="margin-top:16px" onclick="exportToExcel()">ğŸ“Š ì„ìƒ ë°ì´í„° Excel ì¶”ì¶œ (v2.0)</button>
    </div>

    </div><!-- /page-routine -->

    <!-- â˜… PAGE: PROFILE â˜… -->
    <div class="main-page" id="page-profile">

    <div class="glass-card">
        <span class="section-label">ğŸ‘¤ í”„ë¡œí•„ ë° ë¶„ì„ ì„¤ì •</span>
        <div class="profile-grid no-print">
            <div class="input-group"><label>ì´ë¦„</label><input type="text" id="p-name" placeholder="í™ê¸¸ë™"></div>
            <div class="input-group"><label>ë‚˜ì´</label><input type="number" id="p-age" min="10" max="120" placeholder="30"></div>
            <div class="input-group"><label>ì„±ë³„</label><select id="p-gender"><option value="male">ë‚¨</option><option value="female">ì—¬</option></select></div>
            <div class="input-group"><label>ì±Œë¦°ì§€ ì‹œì‘ì¼</label><input type="date" id="p-start"></div>
            <div class="input-group"><label>ë‹¹ë‡¨ ìœ ë¬´</label><select id="p-diabetic"><option value="no">ë¹„ë‹¹ë‡¨ì¸</option><option value="pre">ì „ë‹¹ë‡¨</option><option value="yes">ë‹¹ë‡¨(ì œ2í˜•)</option></select></div>
            <div class="input-group"><label>í‚¤ (cm)</label><input type="number" id="p-h" value="175"></div>
            <div class="input-group"><label>ì‹œì‘ ì²´ì¤‘(kg)</label><input type="number" id="p-sw" step="0.1" value="80"></div>
            <div class="input-group"><label>ëª©í‘œ ì²´ì¤‘(kg)</label><input type="number" id="p-gw" step="0.1" value="70"></div>
            <div class="input-group"><label>ì£¼ê°„ ê·¼ë ¥ìš´ë™(íšŒ)</label><input type="number" id="p-exercise" value="3" min="0" max="7"></div>
            <div class="input-group"><label>ìœ„ë„ (ìë™)</label><input type="number" id="p-lat" step="0.1" value="37.5"></div>
        </div>
        <button class="btn btn-primary no-print" onclick="runComprehensiveAnalysis()">ğŸ”¬ ë¶„ì„ ì‹¤í–‰ ë° ë°ì´í„° ê°±ì‹ </button>
    </div>

    <div class="dashboard-grid no-print">
        <div class="chart-card" id="sim-view" style="display:none"><span class="chart-title">ğŸ“‰ IMEM v2.0 4ì£¼ ì˜ˆì¸¡</span><canvas id="simChart" height="200"></canvas></div>
        <div class="chart-card" id="trend-view" style="display:none"><span class="chart-title">ğŸ“ˆ ì‹¤ì œ ì²´ì¤‘ ì¶”ì´</span><canvas id="trendChart" height="200"></canvas></div>
    </div>

    </div><!-- /page-profile -->

</div>

<!-- RECOVERY POPUP -->
<div class="recovery-popup" id="recovery-popup">
    <div class="recovery-card">
        <div class="recovery-top">
            <div class="recovery-title">ğŸš‘ íšŒë³µ ë¯¸ì…˜</div>
            <button class="recovery-close" onclick="closeRecovery()">&times;</button>
        </div>
        <div class="recovery-body">
            <div class="recovery-penalty" id="recovery-penalty-text">ğŸ“‰ -10ì  í˜ë„í‹° ë°œìƒ</div>
            <div class="recovery-mission" id="recovery-mission-text">ğŸƒ ì¦‰ì‹œ ì±„ì†Œë¥¼ 5ë¶„ê°„ ë¨¼ì € ë“œì„¸ìš”!</div>
        </div>
        <div class="recovery-actions">
            <button class="recovery-btn recovery-btn-do" id="recovery-do-btn" onclick="doRecovery()">âœ… íšŒë³µ ë¯¸ì…˜ ìˆ˜í–‰!</button>
            <button class="recovery-btn recovery-btn-skip" onclick="skipRecovery()">ê±´ë„ˆë›°ê¸°</button>
        </div>
    </div>
</div>

<!-- â˜… AI NUDGE MODAL â€” v5.0 â˜… -->
<div class="ai-modal" id="ai-modal" onclick="if(event.target===this)closeAINudgeModal()">
    <div class="ai-modal-content">
        <div class="ai-modal-header">
            <h2>ğŸ§  AI ë„›ì§€ v2.0</h2>
            <button class="ai-modal-close" onclick="closeAINudgeModal()">&times;</button>
        </div>
        <div style="margin-bottom:16px">
            <label style="font-size:.65rem;font-weight:700;color:var(--text-sub);display:block;margin-bottom:6px">í˜ë¥´ì†Œë‚˜ ì„ íƒ</label>
            <select class="ai-persona-select" id="ai-persona" onchange="updateAIStatus()" style="width:100%;padding:10px 14px;font-size:.85rem">
                <option value="clinical">ğŸ”¬ ì„ìƒ ì „ë¬¸ê°€</option>
                <option value="driver">ğŸ”¥ ê²°ê³¼ ì§€í–¥</option>
                <option value="empathetic">ğŸ¤ ê³µê° íŒŒíŠ¸ë„ˆ</option>
            </select>
        </div>
        <div id="ai-nudge" class="ai-content" style="min-height:80px">ë°ì´í„° ë¶„ì„ì„ ìœ„í•´ ë£¨í‹´ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.</div>
    </div>
</div>

<!-- â˜… GUIDE POPUP â€” v5.0 â˜… -->
<div class="guide-popup-overlay" id="guide-popup" onclick="if(event.target===this)closeGuidePopup()">
    <div class="guide-popup-card">
        <div class="guide-popup-header">
            <div class="guide-popup-title" id="guide-popup-title">ğŸ“– ê°€ì´ë“œ</div>
            <button class="guide-popup-close" onclick="closeGuidePopup()">&times;</button>
        </div>
        <div id="guide-popup-body"></div>
    </div>
</div>

<script>
// ============================================================
// FIREBASE CONFIG
// ============================================================
const firebaseConfig = {
    apiKey: "AIzaSyAmvW0gVPtybG43_nsPVXTNWFAA4MkTmk8",
    authDomain: "incretina-i-pro.firebaseapp.com",
    projectId: "incretina-i-pro",
    storageBucket: "incretina-i-pro.firebasestorage.app",
    messagingSenderId: "649157897211",
    appId: "1:649157897211:web:0f31b8985aad5f6d14795e",
    measurementId: "G-P3NVEW4S3Y"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(e=>console.warn('Persistence:',e.code));
let currentUser=null,unsubProfile=null,unsubHistory=null;

// ============================================================
// AUTH
// ============================================================
function setLoading(on){document.getElementById('status-bar').className=on?'auth-status-bar loading':'auth-status-bar';document.querySelectorAll('.auth-btn').forEach(b=>b.disabled=on)}
function showAuthError(m){document.getElementById('auth-error').textContent=m;setTimeout(()=>document.getElementById('auth-error').textContent='',5000)}
function toggleAuthMode(){const l=document.getElementById('auth-login'),r=document.getElementById('auth-register');l.style.display=l.style.display==='none'?'block':'none';r.style.display=r.style.display==='none'?'block':'none';document.getElementById('auth-error').textContent=''}
async function emailLogin(){const e=document.getElementById('auth-email').value.trim(),p=document.getElementById('auth-pw').value;if(!e||!p)return showAuthError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');setLoading(true);try{await auth.signInWithEmailAndPassword(e,p)}catch(er){const m={'auth/user-not-found':'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.','auth/wrong-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.','auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.','auth/too-many-requests':'ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'};showAuthError(m[er.code]||er.message)}setLoading(false)}
async function emailRegister(){const e=document.getElementById('reg-email').value.trim(),p=document.getElementById('reg-pw').value,p2=document.getElementById('reg-pw2').value;if(!e||!p)return showAuthError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');if(p.length<6)return showAuthError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');if(p!==p2)return showAuthError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');setLoading(true);try{await auth.createUserWithEmailAndPassword(e,p)}catch(er){const m={'auth/email-already-in-use':'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.','auth/invalid-email':'ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.','auth/weak-password':'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.'};showAuthError(m[er.code]||er.message)}setLoading(false)}
async function guestLogin(){setLoading(true);try{await auth.signInAnonymously()}catch(e){showAuthError('ê²ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message)}setLoading(false)}
async function doLogout(){if(unsubProfile)unsubProfile();if(unsubHistory)unsubHistory();await auth.signOut()}
auth.onAuthStateChanged(user=>{currentUser=user;if(user){document.getElementById('auth-screen').style.display='none';document.getElementById('app-container').style.display='block';const email=user.email||'ê²ŒìŠ¤íŠ¸ ì‚¬ìš©ì';document.getElementById('user-email').textContent=email;document.getElementById('user-avatar').textContent=user.email?user.email[0].toUpperCase():'G';initApp()}else{document.getElementById('auth-screen').style.display='flex';document.getElementById('app-container').style.display='none';currentUser=null}});

// ============================================================
// FIRESTORE
// ============================================================
function userDoc(){return db.collection('users').doc(currentUser.uid)}
function historyCollection(){return userDoc().collection('dailyRoutines')}
async function saveProfileToCloud(){if(!currentUser)return;try{await userDoc().set({name:document.getElementById('p-name').value,age:document.getElementById('p-age').value,gender:document.getElementById('p-gender').value,start:document.getElementById('p-start').value,h:document.getElementById('p-h').value,sw:document.getElementById('p-sw').value,gw:document.getElementById('p-gw').value,isDiabetic:document.getElementById('p-diabetic').value,exercise:document.getElementById('p-exercise').value,lat:document.getElementById('p-lat').value,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});showSyncStatus('synced')}catch(e){console.error('Profile save:',e);showSyncStatus('offline')}}

async function saveDailyToCloud(){
    if(!currentUser)return;
    const dateKey=document.getElementById('target-date').value;
    if(!dateKey)return;
    const checks=routine.map((_,i)=>document.getElementById(`item-${i}`)?.classList.contains('checked')||false);
    const riskChecks=risks.map((_,i)=>document.getElementById(`risk-${i}`)?.classList.contains('active')||false);
    const recoveries=risks.map((_,i)=>recoveryDone[i]||false);
    const imem=calculateIMEM();
    const score=calculateTotalScore();
    const data={
        score,checks,riskChecks,recoveries,
        weight:document.getElementById('daily-weight').value||'',
        alpha_net:imem.alpha_net,beta_net:imem.beta_net,gamma_net:imem.gamma_net,
        alpha_penalty:imem.alpha_penalty,beta_penalty:imem.beta_penalty,gamma_penalty:imem.gamma_penalty,
        penaltyTotal:getTotalPenalty(),recoveryTotal:getTotalRecovery(),
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    };
    try{await historyCollection().doc(dateKey).set(data);showSyncStatus('synced')}catch(e){console.error('Daily save:',e);showSyncStatus('offline')}
}
function showSyncStatus(s){const b=document.getElementById('sync-badge');if(s==='synced'){b.className='sync-badge';b.innerHTML='<span class="dot"></span> Cloud Synced'}else{b.className='sync-badge offline';b.innerHTML='<span class="dot"></span> Offline'}}
function listenToProfile(){if(unsubProfile)unsubProfile();unsubProfile=userDoc().onSnapshot(doc=>{if(doc.exists){const p=doc.data();if(p.name)document.getElementById('p-name').value=p.name;if(p.age)document.getElementById('p-age').value=p.age;if(p.gender)document.getElementById('p-gender').value=p.gender;if(p.start)document.getElementById('p-start').value=p.start;if(p.h)document.getElementById('p-h').value=p.h;if(p.sw)document.getElementById('p-sw').value=p.sw;if(p.gw)document.getElementById('p-gw').value=p.gw;if(p.isDiabetic)document.getElementById('p-diabetic').value=p.isDiabetic;if(p.exercise)document.getElementById('p-exercise').value=p.exercise;if(p.lat)document.getElementById('p-lat').value=p.lat}showSyncStatus('synced')},e=>{console.warn('Profile listen:',e);showSyncStatus('offline')})}
function listenToHistory(){if(unsubHistory)unsubHistory();unsubHistory=historyCollection().onSnapshot(snap=>{const hist={};snap.forEach(doc=>{hist[doc.id]=doc.data()});window._cloudHistory=hist;loadDateData();showSyncStatus('synced')},e=>{console.warn('History listen:',e);showSyncStatus('offline')})}

function loadDateData(){
    const hist=window._cloudHistory||{};
    const dateKey=document.getElementById('target-date').value;
    const data=hist[dateKey];
    routine.forEach((_,i)=>{const el=document.getElementById(`item-${i}`);if(el){if(data&&data.checks&&data.checks[i])el.classList.add('checked');else el.classList.remove('checked')}});
    risks.forEach((_,i)=>{const el=document.getElementById(`risk-${i}`);if(el){if(data&&data.riskChecks&&data.riskChecks[i])el.classList.add('active');else el.classList.remove('active')}});
    if(data&&data.recoveries)data.recoveries.forEach((v,i)=>{recoveryDone[i]=v});else recoveryDone.fill(false);
    document.getElementById('daily-weight').value=(data&&data.weight)?data.weight:'';
    fullRefresh();
    updateTrendChart();
}

// ============================================================
// ROUTINE DATA (10 positive)
// ============================================================
const routine=[
    {t:"07:00",title:"ìƒì²´ ë¦¬ë“¬ ë¦¬ì…‹",icon:"ğŸŒ…",pts:8,imem:"Î±",action:"ê¸°ìƒ 10ë¶„ ë‚´ ì§ì‚¬ê´‘ì„  5ë¶„ + ë¬¼ 300ml",detail:"ë§ë§‰ìœ¼ë¡œ ìœ ì…ëœ í–‡ë¹›ì€ ë©œë¼í† ë‹Œì„ ì°¨ë‹¨í•˜ê³  ì„¸ë¡œí† ë‹Œ í•©ì„±ì„ ìœ ë„í•˜ì—¬ ìƒì²´ ì‹œê³„ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤."},
    {t:"08:30",title:"ì»¤í”¼ ëŒ€ì‚¬ ë¶€ìŠ¤íŠ¸",icon:"â˜•",pts:5,imem:"Î±",action:"ë¬´ê°€ë‹¹ ë¸”ë™ì»¤í”¼ 1ì”",detail:"í´ë¡œë¡œê²ì‚°ì´ L-ì„¸í¬ë¥¼ ìê·¹í•´ GLP-1 ë¶„ë¹„ë¥¼ ì˜ˆì—´í•©ë‹ˆë‹¤."},
    {t:"09:00",title:"14h ë‹¨ì‹ í•´ì œ",icon:"ğŸ³",pts:7,imem:"Î±",action:"ì²« ìŒì‹ ì„­ì·¨ + 14ì‹œê°„ ê³µë³µ ë‹¬ì„±",detail:"14ì‹œê°„ ê³µë³µ í›„ AMPK íš¨ì†Œê°€ ê°•ë ¥í•˜ê²Œ í™œì„±í™”ë©ë‹ˆë‹¤."},
    {t:"11:00",title:"í˜¸ë¥´ëª¬ í”„ë¦¬ë¡œë“œ",icon:"ğŸ¥œ",pts:12,crit:true,imem:"Î²_pre",action:"ì ì‹¬ 30ë¶„ ì „ ë‹¨ë°±ì§ˆ 15g + ì‹ì´ì„¬ìœ  5g",detail:"ì‹ì´ì„¬ìœ ì™€ ë‹¨ë°±ì§ˆì´ ì†Œì¥ì— ë¨¼ì € ë„ì°©í•˜ë©´ GLP-1ì´ ì„ ì œ ë¶„ë¹„ë©ë‹ˆë‹¤."},
    {t:"12:00",title:"ì¸í¬ë ˆí‹´ ì‹œí€€ìŠ¤",icon:"ğŸ¥—",pts:13,crit:true,imem:"Î²_seq",action:"ì±„ì†Œ â†’ ë‹¨ë°±ì§ˆ â†’ íƒ„ìˆ˜í™”ë¬¼ ìˆœì„œ ê³ ìˆ˜",detail:"ì˜ì–‘ì†Œ ì…ë ¥ ìˆœì„œë¡œ ìœ„ ë°°ì¶œ ì†ë„ë¥¼ ë¬¼ë¦¬ì ìœ¼ë¡œ ì§€ì—°ì‹œí‚µë‹ˆë‹¤."},
    {t:"12:50",title:"ê¸€ë£¨ì½”ìŠ¤ í´ë¦¬ì–´ëŸ°ìŠ¤",icon:"ğŸš¶",pts:13,crit:true,imem:"Î²_seq",action:"ì‹í›„ 40ë¶„ ë‚´ ë¹ ë¥¸ ê±·ê¸° 30~40ë¶„",detail:"GLUT4 ìˆ˜ìš©ì²´ë¥¼ ê°•ì œ í™œì„±í™”í•˜ì—¬ í˜ˆë‹¹ì„ ì§ì ‘ ì—°ì†Œí•©ë‹ˆë‹¤."},
    {t:"19:00",title:"ì €ë… ë§ˆê° (Metabolic Switch)",icon:"â°",pts:17,crit:true,imem:"Î±",action:"19ì‹œ ì´ì „ ë§ˆì§€ë§‰ ì‹ì‚¬ ì™„ë£Œ",detail:"ì¸ìŠë¦°ì„ ê¸°ì € ìˆ˜ì¤€ìœ¼ë¡œ ë‚®ì¶”ì–´ ì§€ë°© ì—°ì†Œ ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤."},
    {t:"20:30",title:"ê·¼ìœ¡ ë°©ì–´ ë³´í˜¸ë§‰",icon:"ğŸ’ª",pts:10,imem:"Î³",action:"ìŠ¤ì¿¼íŠ¸ ë“± ëŒ€ê·¼ìœ¡ ì¤‘ì‹¬ ê·¼ë ¥ìš´ë™ 30ë¶„",detail:"ë§ˆì´ì˜¤ì¹´ì¸ìœ¼ë¡œ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±(Î³)ì„ ë†’ì´ê³  ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ì €í•˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤."},
    {t:"22:00",title:"ë©œë¼í† ë‹Œ ì„¸ì´í”„ê°€ë“œ",icon:"ğŸŒ™",pts:8,imem:"Î±",action:"ë¸”ë£¨ë¼ì´íŠ¸ ì°¨ë‹¨ ë° ì‹¤ë‚´ ì¡°ë„ ë‚®ì¶”ê¸°",detail:"ë©œë¼í† ë‹Œ í•©ì„±ì„ ë„ì™€ ë‚´ì¼ ì•„ì¹¨ì˜ ëŒ€ì‚¬ ìœ ì—°ì„±ì„ ì¤€ë¹„í•©ë‹ˆë‹¤."},
    {t:"23:00",title:"ì‹¬ì¸µ ëŒ€ì‚¬ ë³µêµ¬",icon:"ğŸ˜´",pts:7,imem:"Î±",action:"ì™„ì „ ì•”ë§‰ í™˜ê²½ì—ì„œ 7~8ì‹œê°„ ìˆ™ë©´",detail:"ìˆ˜ë©´ ì¤‘ ë ™í‹´ì´ ì •ìƒí™”ë˜ê³  ì½”ë¥´í‹°ì†”ì´ ë‚®ì•„ì§‘ë‹ˆë‹¤."}
];

// ============================================================
// RISK DATA (8 negative) â€” v4.0 NEW
// ============================================================
const risks=[
    {id:"R-01",t:"~09:00",title:"ëŠ¦ì  / ê¸°ìƒ ì§€ì—°",icon:"ğŸ˜´",penalty:-5,coeff:"Î±",trigger:"09ì‹œ ì´í›„ ê¸°ìƒ, ì˜¤ì „ ë¹› ë…¸ì¶œ ì—†ìŒ",
     recovery:"ê´‘ì ìƒ¤ì›Œ: ì¦‰ì‹œ 10ë¶„ê°„ í–‡ë¹› ì¬ê¸°",recPts:5,recRate:"100%",science:"ë¹› ìê·¹ìœ¼ë¡œ ì‹œêµì°¨ìƒí•µ(SCN)ì„ ê¹¨ì›Œ ìƒì²´ ì‹œê³„ë¥¼ ì¬ì„¤ì •"},
    {id:"R-02",t:"~09:30",title:"ê°€ë‹¹ ìŒë£Œ / ë¯¹ìŠ¤ì»¤í”¼",icon:"ğŸ§‹",penalty:-8,coeff:"Î²",trigger:"ì•¡ìƒê³¼ë‹¹ì´ ë“  ìŒë£Œ ì„­ì·¨ (ê³µë³µ ìƒíƒœ)",
     recovery:"ê³„ë‹¨ 5ì¸µ ì˜¤ë¥´ê¸°",recPts:4,recRate:"50%",science:"ì„­ì·¨í•œ ë‹¹ë¶„ì„ ê·¼ìœ¡ì´ ì¦‰ê°ì ì¸ ì—ë„ˆì§€ì›ìœ¼ë¡œ ì‚¬ìš©í•˜ê²Œ í•©ë‹ˆë‹¤"},
    {id:"R-03",t:"~11:00",title:"í”„ë¦¬ë¡œë“œ ê±´ë„ˆëœ€",icon:"â­ï¸",penalty:-6,coeff:"Î²",trigger:"GLP-1 ì‚¬ì „ ë¶„ë¹„ ì‹¤íŒ¨",
     recovery:"ë¬¼ 500ml ì›ìƒ·",recPts:3,recRate:"50%",science:"ìœ„ì¥ê´€ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ì±„ì›Œ í¬ë§Œê° ì‹ í˜¸ë¥¼ ë³´ë‚´ ê³¼ì‹ì„ ë°©ì§€"},
    {id:"R-04",t:"~12:00",title:"ì‹ì‚¬ ìˆœì„œ ìœ„ë°˜ (íƒ„ìˆ˜ ìš°ì„ )",icon:"ğŸš",penalty:-10,coeff:"Î²",trigger:"ë°¥/ë©´ë¶€í„° ë¨¹ì–´ í˜ˆë‹¹ ìŠ¤íŒŒì´í¬ ë°œìƒ",
     recovery:"ì±„ì†Œ ê¸´ê¸‰ íˆ¬ì…: ì§€ê¸ˆ ì±„ì†Œë¥¼ 5ë¶„ê°„ ë¨¼ì € ì”¹ìœ¼ì„¸ìš”",recPts:6,recRate:"60%",science:"ì‹ì´ì„¬ìœ ê°€ ì¥ë‚´ ë¬¼ë¦¬ì  ê·¸ë¬¼ì„ í˜•ì„±í•˜ì—¬ íƒ„ìˆ˜í™”ë¬¼ í¡ìˆ˜ë¥¼ ëŠ¦ì¶¤"},
    {id:"R-05",t:"~15:00",title:"1ì‹œê°„+ ì—°ì† ì¢Œì‹",icon:"ğŸª‘",penalty:-4,coeff:"Î³",trigger:"í—ˆë²…ì§€ ê·¼ìœ¡ í¬ë„ë‹¹ í¡ìˆ˜ë ¥ ì €í•˜",
     recovery:"ìŠ¤ì¿¼íŠ¸ 10íšŒ",recPts:4,recRate:"100%",science:"í—ˆë²…ì§€ ê·¼ìœ¡ ìê·¹ìœ¼ë¡œ ë§ˆì´ì˜¤ì¹´ì¸(IL-6) ë¶„ë¹„ ìœ ë„"},
    {id:"R-06",t:"19:00~",title:"19ì‹œ ì´í›„ ëŠ¦ì€ ì‹ì‚¬",icon:"ğŸ•",penalty:-12,coeff:"Î±",trigger:"ë©œë¼í† ë‹Œ-ì¸ìŠë¦° ì¶©ëŒ, ëŒ€ì‚¬ ë¶€ì±„ ë°œìƒ",
     recovery:"ê³µë³µ ì‹œê°„ ì—°ì¥: ë‚´ì¼ ì•„ì¹¨ ë‹¨ì‹ì„ 1ì‹œê°„ ë” ëŠ˜ë¦¬ì„¸ìš”",recPts:8,recRate:"67%",science:"ëŠ¦ê²Œ ë¨¹ì€ ë§Œí¼ ê³µë³µ ì‹œê°„ì„ ëŠ˜ë ¤ ì¸ìŠë¦° íœ´ì‹ ì‹œê°„ í™•ë³´"},
    {id:"R-07",t:"21:00~",title:"ì•¼ì‹ ì„­ì·¨",icon:"ğŸ•",penalty:-20,coeff:"Î±",trigger:"ì§€ë°© ì €ì¥ ëª¨ë“œ ì§í–‰, ì¹˜ëª…ì  ëŒ€ì‚¬ ë¶€ì±„",
     recovery:"ì¦‰ì‹œ ì–‘ì¹˜ì§ˆ + 20ë¶„ ìŠ¤íŠ¸ë ˆì¹­",recPts:8,recRate:"40%",science:"ì…ë§› ì´ˆê¸°í™” + í˜ˆë‹¹ì„ ê·¼ìœ¡ì—ì„œ ì†Œëª¨ì‹œì¼œ ì§€ë°© ì¶•ì  ë°©ì–´"},
    {id:"R-08",t:"23:00~",title:"ë¸”ë£¨ë¼ì´íŠ¸ ë…¸ì¶œ",icon:"ğŸ“±",penalty:-6,coeff:"Î±",trigger:"ë©œë¼í† ë‹Œ ì–µì œ â†’ ë‹¤ìŒë‚  ì‹ìš• í­ë°œ",
     recovery:"í° ë„ê¸° + 5ë¶„ ëª…ìƒ",recPts:3,recRate:"50%",science:"ì¦‰ì‹œ ë¹› ì°¨ë‹¨ìœ¼ë¡œ ë©œë¼í† ë‹Œ ë¶„ë¹„ë¥¼ ì •ìƒí™”"}
];

let recoveryDone = new Array(risks.length).fill(false);
let currentRecoveryIndex = -1;

// ============================================================
// NUDGE MESSAGES (v2.0 with penalty awareness)
// ============================================================
const nudges={
    clinical:{
        master:"ìµœì ì˜ ëŒ€ì‚¬ íš¨ìœ¨ ë‹¬ì„± (Î±_net={a}, Î²_net={b}, Î³_net={g}). í˜ë„í‹° ì—†ì´ ì™„ë²½í•œ í•˜ë£¨ì…ë‹ˆë‹¤.",
        achiever:"í˜„ì¬ Î±_net={a}. ê³¨ë“ íƒ€ì„ ë‚´ ì‹ì‚¬ë¥¼ ì™„ë£Œí•˜ë©´ Î± ìƒí–¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë§ˆì´ë„ˆìŠ¤ ë£¨í‹´ì„ ì£¼ì˜í•˜ì„¸ìš”.",
        reset:"ê²½ê³ : ì¢…í•© íš¨ìœ¨ {total}. ëŒ€ì‚¬ ë¶€ì±„ê°€ ëˆ„ì ë˜ê³  ìˆìŠµë‹ˆë‹¤. íšŒë³µ ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”.",
        penalty:"âš ï¸ Î±_netì´ {a}ë¡œ í•˜ë½. í˜ë„í‹° {pen}ì  ë°œìƒ. ì¦‰ê° íšŒë³µ ë¯¸ì…˜ìœ¼ë¡œ {rec}ì  ë³µêµ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    },
    driver:{
        master:"ì™„ë²½! Î±={a} Ã— Î²={b} Ã— Î³={g} = {total}. ì˜¤ëŠ˜ ë°©ì–´ ì„±ê³µ!",
        achiever:"ë°©ì–´ì„  ìœ ì§€ ì¤‘. í˜ë„í‹°ë¥¼ 0ìœ¼ë¡œ ë§Œë“œì„¸ìš”!",
        reset:"ê²½ê³ : íš¨ìœ¨ {total}. ì§€ê¸ˆ íšŒë³µí•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ëŠ˜ì˜ ë…¸ë ¥ì´ ë¬´ì˜ë¯¸í•´ì§‘ë‹ˆë‹¤!",
        penalty:"ğŸ”´ {pen}ì  ì†ì‹¤! ì§€ê¸ˆ íšŒë³µ ë¯¸ì…˜ì„ í•˜ë©´ {rec}ì  ë˜ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íƒ€í˜‘í•˜ì§€ ë§ˆì‹­ì‹œì˜¤!"
    },
    empathetic:{
        master:"ì˜¤ëŠ˜ ì •ë§ ì™„ë²½í•œ í•˜ë£¨ì˜€ì–´ìš”! ë§ˆì´ë„ˆìŠ¤ ë£¨í‹´ í•˜ë‚˜ ì—†ì´ í•´ë‚´ì…¨ë„¤ìš” ğŸ˜Š",
        achiever:"ì˜ í•˜ê³  ìˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” ì‹ ê²½ ì“°ë©´ ìµœì  êµ¬ê°„ì´ì—ìš”.",
        reset:"ì˜¤ëŠ˜ ì¢€ í˜ë“œì…¨ì£ ? ê´œì°®ì•„ìš”. íšŒë³µ ë¯¸ì…˜ í•˜ë‚˜ë§Œ í•´ë„ ì¶©ë¶„í•´ìš” ğŸ’ª",
        penalty:"ì‹¤ìˆ˜ëŠ” ëˆ„êµ¬ë‚˜ í•´ìš”. ì§€ê¸ˆ {rec}ì ì„ ë˜ì°¾ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆì–´ìš”. í•´ë³¼ê¹Œìš”?"
    }
};

// ============================================================
// BIO-SYNC TIMER
// ============================================================
let currentSunrise,currentSunset,isNightMode=false,themeManualOverride=false;
function calculateSunTimes(lat){const d=new Date(),dy=Math.floor((d-new Date(d.getFullYear(),0,0))/86400000),dec=23.45*Math.sin((2*Math.PI/365)*(dy-81)),lr=lat*Math.PI/180,dr=dec*Math.PI/180;let ha=Math.acos(-Math.tan(lr)*Math.tan(dr))*180/Math.PI/15;const n=12;return{sunrise:{h:Math.floor(n-ha),m:Math.round(((n-ha)%1)*60)},sunset:{h:Math.floor(n+ha),m:Math.round(((n+ha)%1)*60)}}}
function timeToMinutes(h,m){return h*60+m}function minutesToStr(m){return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`}
function updateBioSyncTimer(){const lat=parseFloat(document.getElementById('p-lat').value)||37.5,sun=calculateSunTimes(lat);currentSunrise=sun.sunrise;currentSunset=sun.sunset;document.getElementById('sunrise-time').textContent=minutesToStr(timeToMinutes(sun.sunrise.h,sun.sunrise.m));document.getElementById('sunset-time').textContent=minutesToStr(timeToMinutes(sun.sunset.h,sun.sunset.m));document.getElementById('location-label').textContent=`ğŸ“ ìœ„ë„ ${lat}Â°N`;const now=new Date(),nowM=timeToMinutes(now.getHours(),now.getMinutes()),srM=timeToMinutes(sun.sunrise.h,sun.sunrise.m),ssM=timeToMinutes(sun.sunset.h,sun.sunset.m),gT=ssM-srM;const mb=document.getElementById('mode-badge'),gt=document.getElementById('golden-title'),gs=document.getElementById('golden-sub');const ct=document.getElementById('countdown-time'),cl=document.getElementById('countdown-label');const ring=document.getElementById('countdown-ring'),circ=301.6;const pB=document.getElementById('golden-progress'),pP=document.getElementById('golden-pct');const ov=document.getElementById('fasting-overlay');if(nowM>=srM&&nowM<ssM){const el=nowM-srM,rm=ssM-nowM,pct=Math.round((el/gT)*100);mb.className='biosync-mode mode-day';mb.innerHTML='â˜€ï¸ DAY MODE â€” GOLDEN TIME';gt.textContent='ğŸŒ… ê³¨ë“ íƒ€ì„ ì§„í–‰ ì¤‘';if(rm<=30){gs.textContent='âš ï¸ ë¼ìŠ¤íŠ¸ì½œ! ë§ˆì§€ë§‰ ì‹ì‚¬ë¥¼ ì§€ê¸ˆ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”!';gs.style.color='var(--danger)';ring.style.stroke='var(--danger)'}else if(rm<=60){gs.textContent='ğŸ”¶ ê³¨ë“ íƒ€ì„ ì¢…ë£Œ 1ì‹œê°„ ì „.';gs.style.color='var(--accent)';ring.style.stroke='var(--accent)'}else{gs.textContent='ì¸í¬ë ˆí‹´ í˜¸ë¥´ëª¬ ë¶„ë¹„ê°€ í™œë°œí•œ ì‹œê°„ì…ë‹ˆë‹¤.';gs.style.color='var(--text-sub)';ring.style.stroke='var(--success)'}ct.textContent=`${Math.floor(rm/60)}h ${String(rm%60).padStart(2,'0')}m`;cl.textContent='ë‚¨ì€ ì‹œê°„';ring.style.strokeDashoffset=circ*(1-rm/gT);pB.style.width=pct+'%';pB.style.background='var(--golden-gradient)';pP.textContent=pct+'%';if(!themeManualOverride){setTheme('day');ov.classList.remove('active')}isNightMode=false}else{mb.className='biosync-mode mode-night';mb.innerHTML='ğŸŒ™ NIGHT MODE â€” ëŒ€ì‚¬ íœ´ì‹';gt.textContent='ğŸŒ™ ëŒ€ì‚¬ íœ´ì‹ ëª¨ë“œ';gs.textContent='ì•¼ê°„ ê³µë³µì„ ìœ ì§€í•˜ë©´ ë‚´ì¼ ì¸í¬ë ˆí‹´ ê°ìˆ˜ì„±ì´ ê·¹ëŒ€í™”ë©ë‹ˆë‹¤.';gs.style.color='var(--text-sub)';ring.style.stroke='#6366f1';let toSR=nowM>=ssM?(1440-nowM)+srM:srM-nowM;ct.textContent=`${Math.floor(toSR/60)}h ${String(toSR%60).padStart(2,'0')}m`;cl.textContent='ì¼ì¶œê¹Œì§€';ring.style.strokeDashoffset=circ*.2;pB.style.width='100%';pB.style.background='linear-gradient(135deg,#6366f1,#3b82f6)';pP.textContent='ì™„ë£Œ';if(!themeManualOverride){setTheme('night');ov.classList.add('active')}isNightMode=true}}
function setTheme(m){document.documentElement.setAttribute('data-theme',m==='night'?'night':'');document.getElementById('theme-toggle').textContent=m==='night'?'ğŸŒ™':'â˜€ï¸'}
function toggleThemeManual(){themeManualOverride=true;const n=document.documentElement.getAttribute('data-theme')==='night';setTheme(n?'day':'night');setTimeout(()=>{themeManualOverride=false},30000)}

// ============================================================
// IMEM v2.0 ENGINE â€” PENALTY + RECOVERY
// ============================================================
function calculateIMEM(){
    const checks=routine.map((_,i)=>document.getElementById(`item-${i}`)?.classList.contains('checked')||false);
    const riskActive=risks.map((_,i)=>document.getElementById(`risk-${i}`)?.classList.contains('active')||false);

    // Î± base + bonus
    let alpha=1.0;
    if(checks[6]){const ssM=currentSunset?timeToMinutes(currentSunset.h,currentSunset.m):1080;alpha=ssM>=1140?1.10:1.05}else if(isNightMode){alpha=0.90}
    if(checks[0])alpha+=0.02;if(checks[8]&&checks[9])alpha+=0.02;

    // Î± penalty
    let alpha_pen=0;
    if(riskActive[0])alpha_pen+=0.05;  // R-01 ëŠ¦ì 
    if(riskActive[5])alpha_pen+=0.10;  // R-06 19ì‹œì´í›„
    if(riskActive[6])alpha_pen+=0.20;  // R-07 ì•¼ì‹
    if(riskActive[7])alpha_pen+=0.04;  // R-08 ë¸”ë£¨ë¼ì´íŠ¸

    // Î± recovery
    let alpha_rec=0;
    if(riskActive[0]&&recoveryDone[0])alpha_rec+=0.05;
    if(riskActive[5]&&recoveryDone[5])alpha_rec+=0.10*0.67;
    if(riskActive[6]&&recoveryDone[6])alpha_rec+=0.20*0.40;
    if(riskActive[7]&&recoveryDone[7])alpha_rec+=0.04*0.50;

    let alpha_net=Math.max(0.75,Math.min(1.14,Math.round((alpha-alpha_pen+alpha_rec)*100)/100));

    // Î² base
    let beta_pre=checks[3]?1.025:1.0;
    let beta_seq=(checks[4]&&checks[5])?1.025:(checks[4]?1.015:1.0);
    let beta_base=Math.round((beta_pre*beta_seq)*1000)/1000;

    // Î² penalty
    let beta_pen=0;
    if(riskActive[1])beta_pen+=0.03;  // R-02 ê°€ë‹¹ìŒë£Œ
    if(riskActive[2])beta_pen+=0.02;  // R-03 í”„ë¦¬ë¡œë“œìŠ¤í‚µ
    if(riskActive[3])beta_pen+=0.05;  // R-04 ìˆœì„œìœ„ë°˜

    // Î² recovery
    let beta_rec=0;
    if(riskActive[1]&&recoveryDone[1])beta_rec+=0.03*0.50;
    if(riskActive[2]&&recoveryDone[2])beta_rec+=0.02*0.50;
    if(riskActive[3]&&recoveryDone[3])beta_rec+=0.05*0.60;

    let beta_net=Math.max(0.90,Math.min(1.051,Math.round((beta_base-beta_pen+beta_rec)*1000)/1000));

    // Î³ base
    const isDiabetic=document.getElementById('p-diabetic').value;
    const exCount=parseInt(document.getElementById('p-exercise').value)||0;
    let gamma_base=isDiabetic==='yes'?0.85:(isDiabetic==='pre'?0.95:1.00);
    let gamma_ex=exCount>=3&&checks[7]?0.05:(exCount>=3?0.03:(checks[7]?0.02:0));
    let gamma_raw=Math.round((gamma_base*(1+gamma_ex))*100)/100;

    // Î³ penalty
    let gamma_pen=0;
    if(riskActive[4])gamma_pen+=0.02;  // R-05 ì¢Œì‹

    // Î³ recovery
    let gamma_rec=0;
    if(riskActive[4]&&recoveryDone[4])gamma_rec+=0.02;

    let gamma_net=Math.max(0.70,Math.min(1.05,Math.round((gamma_raw-gamma_pen+gamma_rec)*100)/100));

    return {alpha_net,beta_net,gamma_net,alpha_penalty:alpha_pen,beta_penalty:beta_pen,gamma_penalty:gamma_pen};
}

function calculatePositiveScore(){return routine.reduce((s,item,i)=>s+(document.getElementById(`item-${i}`)?.classList.contains('checked')?item.pts:0),0)}

function getTotalPenalty(){
    return risks.reduce((s,r,i)=>{
        if(document.getElementById(`risk-${i}`)?.classList.contains('active'))return s+r.penalty;
        return s;
    },0);
}
function getTotalRecovery(){
    return risks.reduce((s,r,i)=>{
        if(document.getElementById(`risk-${i}`)?.classList.contains('active')&&recoveryDone[i])return s+r.recPts;
        return s;
    },0);
}
function calculateTotalScore(){
    return Math.max(-20,Math.min(100,calculatePositiveScore()+getTotalPenalty()+getTotalRecovery()));
}

// ============================================================
// MAIN TAB NAVIGATION â€” v5.0
// ============================================================
function switchMainTab(tabName){
    const tabs=['dashboard','routine','profile'];
    tabs.forEach(t=>{
        const navBtn=document.getElementById('nav-'+t);
        const page=document.getElementById('page-'+t);
        if(t===tabName){
            navBtn.classList.add('active');
            page.classList.add('active');
        }else{
            navBtn.classList.remove('active');
            page.classList.remove('active');
        }
    });
    // AI ë„›ì§€ íƒ­ì€ popup-triggerì´ë¯€ë¡œ active í•´ì œ
    document.getElementById('nav-ai').classList.remove('active');
}

function showAINudgeModal(){
    updateAIStatus();
    document.getElementById('ai-modal').classList.add('show');
}
function closeAINudgeModal(){
    document.getElementById('ai-modal').classList.remove('show');
}

function showGuidePopup(type,index){
    const popup=document.getElementById('guide-popup');
    const titleEl=document.getElementById('guide-popup-title');
    const bodyEl=document.getElementById('guide-popup-body');

    if(type==='routine'){
        const r=routine[index];
        titleEl.innerHTML=`ğŸ“– ${r.icon} ${r.title}`;
        bodyEl.innerHTML=`
            <div class="guide-box" style="margin-bottom:12px">
                <span class="guide-label">â° ì‹¤í–‰ ì‹œê°„</span>
                <p class="guide-text"><b>${r.t}</b> Â· IMEM ê³„ìˆ˜: <b style="color:var(--primary)">${r.imem}</b> Â· +${r.pts}ì </p>
            </div>
            <div class="guide-box" style="margin-bottom:12px">
                <span class="guide-label">Action Protocol</span>
                <p class="guide-text"><b>${r.action}</b></p>
            </div>
            <div class="guide-box" style="border-left-color:var(--primary)">
                <span class="guide-label">Clinical Mechanism</span>
                <p class="guide-text" style="color:var(--primary)">${r.detail}</p>
            </div>`;
    }else{
        const r=risks[index];
        titleEl.innerHTML=`ğŸ“– ${r.icon} ${r.title}`;
        bodyEl.innerHTML=`
            <div class="guide-box" style="border-left-color:var(--danger);margin-bottom:12px">
                <span class="guide-label">âš ï¸ Risk Factor Â· ${r.id} Â· ${r.coeff}</span>
                <p class="guide-text"><b>${r.trigger}</b></p>
                <p class="guide-text" style="color:var(--danger);font-weight:700;margin-top:6px">${r.penalty}ì  í˜ë„í‹°</p>
            </div>
            <div class="guide-box" style="border-left-color:var(--success);margin-bottom:12px">
                <span class="guide-label">ğŸš‘ Recovery Mission (${r.recRate})</span>
                <p class="guide-text" style="color:var(--success)"><b>${r.recovery}</b><br>â†’ +${r.recPts}ì  íšŒë³µ</p>
            </div>
            <div class="guide-box">
                <span class="guide-label">ğŸ”¬ Science</span>
                <p class="guide-text">${r.science}</p>
            </div>`;
    }
    popup.classList.add('show');
}
function closeGuidePopup(){
    document.getElementById('guide-popup').classList.remove('show');
}

// ============================================================
// ROUTINE SUB-TAB SWITCHING â€” v5.0
// ============================================================
function switchTab(tab){
    const tabPlus=document.getElementById('tab-plus');
    const tabMinus=document.getElementById('tab-minus');
    const contentPlus=document.getElementById('tab-content-plus');
    const contentMinus=document.getElementById('tab-content-minus');

    if(tab==='plus'){
        tabPlus.classList.add('active');tabMinus.classList.remove('active');
        contentPlus.classList.add('active');contentMinus.classList.remove('active');
    }else{
        tabMinus.classList.add('active');tabPlus.classList.remove('active');
        contentMinus.classList.add('active');contentPlus.classList.remove('active');
    }
}

function updateTabBadge(){
    // Plus tab: checked count / total
    const checkedCount=routine.filter((_,i)=>document.getElementById(`item-${i}`)?.classList.contains('checked')).length;
    document.getElementById('tab-plus-count').textContent=`(${checkedCount}/${routine.length})`;

    // Minus tab: active risk count
    const activeRisks=risks.filter((_,i)=>document.getElementById(`risk-${i}`)?.classList.contains('active')).length;
    const badge=document.getElementById('tab-minus-badge');
    badge.textContent=activeRisks;
    if(activeRisks>0){
        badge.classList.add('has-risks');
    }else{
        badge.classList.remove('has-risks');
    }
}

// ============================================================
// UI UPDATES
// ============================================================
function updateIMEMDisplay(){
    const imem=calculateIMEM();
    document.getElementById('alpha-val').textContent=imem.alpha_net.toFixed(2);
    document.getElementById('beta-val').textContent=imem.beta_net.toFixed(3);
    document.getElementById('gamma-val').textContent=imem.gamma_net.toFixed(2);

    const aEl=document.getElementById('alpha-val');
    aEl.style.color=imem.alpha_net>=1.05?'var(--success)':(imem.alpha_net>=1.0?'var(--accent)':'var(--danger)');
    const bEl=document.getElementById('beta-val');
    bEl.style.color=imem.beta_net>=1.02?'var(--success)':(imem.beta_net>=1.0?'var(--accent)':'var(--danger)');
    const gEl=document.getElementById('gamma-val');
    gEl.style.color=imem.gamma_net>=1.0?'var(--success)':(imem.gamma_net>=0.95?'var(--accent)':'var(--danger)');

    document.getElementById('alpha-penalty').textContent=imem.alpha_penalty>0?`â–¼ -${imem.alpha_penalty.toFixed(2)}`:'';
    document.getElementById('beta-penalty').textContent=imem.beta_penalty>0?`â–¼ -${imem.beta_penalty.toFixed(3)}`:'';
    document.getElementById('gamma-penalty').textContent=imem.gamma_penalty>0?`â–¼ -${imem.gamma_penalty.toFixed(2)}`:'';
    return imem;
}

function updateGauge(){
    const score=calculateTotalScore();
    const pen=getTotalPenalty();
    const rec=getTotalRecovery();
    const pct=Math.max(0,Math.min(100,score));

    document.getElementById('gauge-score').textContent=score;
    document.getElementById('gauge-detail').textContent=`+${calculatePositiveScore()} / ${pen} / +${rec} íšŒë³µ`;
    document.getElementById('penalty-total').textContent=pen;
    document.getElementById('recovery-total').textContent=`+${rec}`;

    const bar=document.getElementById('gauge-bar');
    bar.style.width=pct+'%';
    document.getElementById('gauge-bar-pct').textContent=pct+'%';

    let color,textColor;
    if(score>=85){color='linear-gradient(90deg,#3b82f6,#6366f1)';textColor='var(--primary)'}
    else if(score>=70){color='linear-gradient(90deg,#22c55e,#10b981)';textColor='var(--success)'}
    else if(score>=50){color='linear-gradient(90deg,#f59e0b,#eab308)';textColor='var(--accent)'}
    else if(score>=30){color='linear-gradient(90deg,#f97316,#ea580c)';textColor='var(--warning)'}
    else{color='linear-gradient(90deg,#ef4444,#dc2626)';textColor='var(--danger)'}
    bar.style.background=color;
    document.getElementById('gauge-score').style.color=textColor;
}

function updateAIStatus(score){
    if(score===undefined)score=calculateTotalScore();
    const imem=calculateIMEM(),persona=document.getElementById('ai-persona').value;
    const total=(imem.alpha_net*imem.beta_net*imem.gamma_net).toFixed(3);
    const pen=getTotalPenalty(),rec=getTotalRecovery();

    let state;
    if(pen<0&&rec===0)state='penalty';
    else if(score>=85)state='master';
    else if(score>=50)state='achiever';
    else state='reset';

    let msg=(nudges[persona][state]||nudges[persona].reset)
        .replace('{a}',imem.alpha_net.toFixed(2)).replace('{b}',imem.beta_net.toFixed(3))
        .replace('{g}',imem.gamma_net.toFixed(2)).replace('{total}',total)
        .replace('{pen}',pen).replace('{rec}',rec);
    document.getElementById('ai-nudge').textContent=msg;
}

function refreshStats(score){
    const h=parseFloat(document.getElementById('p-h').value)/100,cw=parseFloat(document.getElementById('daily-weight').value)||parseFloat(document.getElementById('p-sw').value),sw=parseFloat(document.getElementById('p-sw').value),gw=parseFloat(document.getElementById('p-gw').value);
    if(h>0&&cw>0)document.getElementById('bmi-v').textContent=(cw/(h*h)).toFixed(1);
    if(sw&&gw&&cw&&sw!==gw){const ach=Math.max(0,Math.min(100,((sw-cw)/(sw-gw))*100));const el=document.getElementById('ach-v');el.textContent=ach.toFixed(1)+'%';el.style.color=ach>=50?'var(--success)':(ach>=25?'var(--accent)':'var(--danger)')}
}

function fullRefresh(){
    const imem=updateIMEMDisplay();
    const score=calculateTotalScore();
    updateGauge();
    updateAIStatus(score);
    refreshStats(score);
    updateTabBadge();
}

// ============================================================
// RENDERING
// ============================================================
let simChart,trendChart;
const dateInput=document.getElementById('target-date');
dateInput.value=new Date().toISOString().split('T')[0];

function renderList(){
    document.getElementById('routine-list').innerHTML=routine.map((item,i)=>`
        <div class="item ${item.crit?'critical':''}" id="item-${i}" onclick="toggleTask(${i})">
            <div class="item-icon">${item.icon}</div>
            <div class="item-body">
                <span class="item-time">${item.t} Â· ${item.imem}</span>
                <span class="item-title">${item.title}</span>
                <span class="item-action">${item.action}</span>
            </div>
            <div class="score-badge">+${item.pts}</div>
            <button class="guide-btn" onclick="event.stopPropagation();showGuidePopup('routine',${i})" title="ê°€ì´ë“œ ë³´ê¸°">ğŸ“–</button>
        </div>`).join('');
}

function renderRiskList(){
    document.getElementById('risk-list').innerHTML=risks.map((r,i)=>`
        <div class="risk-item" id="risk-${i}" onclick="toggleRisk(${i})">
            <div class="item-icon">${r.icon}</div>
            <div class="item-body">
                <span class="item-time" style="color:var(--danger)">${r.t} Â· ${r.coeff} Â· ${r.id}</span>
                <span class="item-title">${r.title}</span>
                <span class="item-action">${r.trigger}</span>
            </div>
            <div class="score-badge">${r.penalty}</div>
            <button class="guide-btn" onclick="event.stopPropagation();showGuidePopup('risk',${i})" title="ê°€ì´ë“œ ë³´ê¸°">ğŸ“–</button>
        </div>`).join('');
}

function toggleModal(id){const m=document.getElementById(id);m.style.display=m.style.display==='flex'?'none':'flex'}

function toggleTask(i){document.getElementById(`item-${i}`).classList.toggle('checked');onDataChange()}

function toggleRisk(i){
    const el=document.getElementById(`risk-${i}`);
    const wasActive=el.classList.contains('active');
    el.classList.toggle('active');

    if(!wasActive){
        // Just activated â€” show recovery popup
        currentRecoveryIndex=i;
        recoveryDone[i]=false;
        showRecoveryPopup(i);
    }else{
        // Deactivated â€” clear recovery
        recoveryDone[i]=false;
    }
    onDataChange();
}

function showRecoveryPopup(i){
    const r=risks[i];
    document.getElementById('recovery-penalty-text').innerHTML=`ğŸ“‰ ${r.penalty}ì  í˜ë„í‹° â€” ${r.title}`;
    document.getElementById('recovery-mission-text').innerHTML=`ğŸš‘ ${r.recovery}<br><span style="font-size:.75rem;color:var(--text-sub)">íšŒë³µ ì‹œ +${r.recPts}ì  (${r.recRate})</span>`;
    document.getElementById('recovery-popup').classList.add('show');
}
function doRecovery(){
    if(currentRecoveryIndex>=0){
        recoveryDone[currentRecoveryIndex]=true;
        currentRecoveryIndex=-1;
    }
    document.getElementById('recovery-popup').classList.remove('show');
    onDataChange();
}
function skipRecovery(){
    currentRecoveryIndex=-1;
    document.getElementById('recovery-popup').classList.remove('show');
}
function closeRecovery(){skipRecovery()}

function onDataChange(){fullRefresh();saveDailyToCloud();saveProfileToCloud()}

function updateTrendChart(){
    const hist=window._cloudHistory||{};
    const sorted=Object.keys(hist).sort();
    const wData=sorted.filter(d=>hist[d].weight).map(d=>({date:d.slice(5),weight:parseFloat(hist[d].weight)}));
    if(wData.length>0){
        document.getElementById('trend-view').style.display='block';
        const ctx=document.getElementById('trendChart').getContext('2d');
        if(trendChart)trendChart.destroy();
        trendChart=new Chart(ctx,{type:'line',data:{labels:wData.map(d=>d.date),datasets:[{data:wData.map(d=>d.weight),borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,.08)',fill:true,tension:.35,pointRadius:4,pointBackgroundColor:'#2563eb',borderWidth:2}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,.05)'}},x:{grid:{display:false}}}}});
    }
}

function runComprehensiveAnalysis(){
    const cw=parseFloat(document.getElementById('daily-weight').value)||parseFloat(document.getElementById('p-sw').value),gw=parseFloat(document.getElementById('p-gw').value);
    const imem=calculateIMEM(),compliance=calculateTotalScore()/100;
    const dailyDeficit=300,baseWeeklyLoss=(dailyDeficit*7)/7700;
    const mult=imem.alpha_net*imem.beta_net*imem.gamma_net;
    let labels=["í˜„ì¬"],weights=[cw],tmp=cw;
    for(let w=1;w<=4;w++){tmp-=((baseWeeklyLoss*mult*Math.max(compliance,.5))+(w===1?.5:0));tmp=Math.max(tmp,gw);labels.push(w+"ì£¼");weights.push(parseFloat(tmp.toFixed(1)))}
    document.getElementById('sim-view').style.display='block';
    const ctx=document.getElementById('simChart').getContext('2d');
    if(simChart)simChart.destroy();
    simChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:weights,borderColor:'#10b981',backgroundColor:'rgba(16,185,129,.08)',borderDash:[6,4],tension:.4,fill:true,pointRadius:5,pointBackgroundColor:'#10b981',borderWidth:2}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,.05)'}},x:{grid:{display:false}}}}});
    onDataChange();
}

function exportToExcel(){
    const hist=window._cloudHistory||{};const hV=parseFloat(document.getElementById('p-h').value)/100;
    const data=Object.keys(hist).sort().map(date=>{const e=hist[date];const w=parseFloat(e.weight)||0;
        return{"ë‚ ì§œ":date,"ê²Œì´ì§€ì ìˆ˜":e.score,"ê¸ì •ì ìˆ˜":e.checks?e.checks.filter(Boolean).length:'0',"í˜ë„í‹°í•©ê³„":e.penaltyTotal||0,"íšŒë³µí•©ê³„":e.recoveryTotal||0,
        "ì²´ì¤‘(kg)":w,"BMI":w>0?(w/(hV*hV)).toFixed(1):"-","Î±_net":e.alpha_net||"-","Î²_net":e.beta_net||"-","Î³_net":e.gamma_net||"-",
        "IMEM":(e.alpha_net&&e.beta_net&&e.gamma_net)?(e.alpha_net*e.beta_net*e.gamma_net).toFixed(3):"-",
        "ë¦¬ìŠ¤í¬":e.riskChecks?e.riskChecks.map((c,i)=>c?risks[i].title:null).filter(Boolean).join(", "):"",
        "íšŒë³µë¯¸ì…˜":e.recoveries?e.recoveries.map((c,i)=>c?risks[i].recovery:null).filter(Boolean).join(", "):""}});
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"IMEM_v2.0_Log");XLSX.writeFile(wb,'IncretinAi_v5.0_DefenseRecovery.xlsx');
}

// ============================================================
// INIT
// ============================================================
function initApp(){
    renderList();renderRiskList();
    listenToProfile();listenToHistory();
    updateBioSyncTimer();setInterval(updateBioSyncTimer,30000);
    fullRefresh();
}
dateInput.addEventListener('change',()=>{recoveryDone.fill(false);loadDateData()});
document.getElementById('daily-weight').addEventListener('input',()=>{saveDailyToCloud()});
document.getElementById('p-lat').addEventListener('change',()=>{updateBioSyncTimer();saveProfileToCloud()});
document.getElementById('p-diabetic').addEventListener('change',onDataChange);
document.getElementById('p-exercise').addEventListener('change',onDataChange);
</script>
</body>
</html>
